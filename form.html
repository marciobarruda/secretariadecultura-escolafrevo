<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matr√≠cula 2025</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> <!-- Adicionado Axios -->
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 60%;
            margin: auto;
            background: #fff;
            padding: 20px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            margin-top: 80px;
        }

        h2,
        h3 {
            background: #f4a000;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 10px;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        h3 i {
            margin-right: 10px;
        }

        label {
            font-weight: bold;
            display: block;
            margin-top: 10px;
            width: 100%;
            font-size: 14px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        .button {
            background: #f4a000;
            /* Cor de fundo */
            color: white;
            /* Cor do texto */
            padding: 15px 20px;
            /* Aumenta o tamanho do bot√£o */
            border: none;
            /* Remove bordas */
            cursor: pointer;
            /* Cursor de m√£ozinha */
            width: 100%;
            /* Bot√£o com 100% de largura */
            max-width: 400px;
            /* Limita a largura m√°xima */
            border-radius: 5px;
            /* Bordas arredondadas */
            margin-top: 20px;
            /* Espa√ßo superior */
            font-size: 18px;
            /* Tamanho da fonte */
            text-align: center;
            /* Texto centralizado */
            display: block;
            /* Garante que o bot√£o ser√° um bloco */
            margin-left: auto;
            /* Centraliza o bot√£o horizontalmente */
            margin-right: auto;
            /* Centraliza o bot√£o horizontalmente */
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            /* Sombra para efeito de profundidade */
            transition: background-color 0.3s, transform 0.2s;
            /* Efeito de transi√ß√£o */
        }

        .button:hover {
            background-color: #e39600;
            /* Cor ao passar o mouse */
            transform: scale(1.05);
            /* Aumenta um pouco o tamanho do bot√£o */
        }

        .button:active {
            background-color: #d38400;
            /* Cor ao clicar */
            transform: scale(1);
            /* Retorna ao tamanho original */
        }


        .progress {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #ddd;
            padding: 15px;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 1000;
        }

        .progress div {
            width: 40px;
            height: 40px;
            background: #bbb;
            color: white;
            text-align: center;
            line-height: 40px;
            border-radius: 50%;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: background 0.3s;
        }

        .progress div.active {
            background: #f4a000;
        }

        .section {
            display: block;
            margin-top: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .modal-content button {
            margin-top: 10px;
            padding: 10px;
            background-color: #f00;
            color: white;
            border: none;
            cursor: pointer;
        }

        #message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
            background: #9b0f08;
            /* Mesma cor do cabe√ßalho do formul√°rio */
            color: white;
            padding: 20px;
            font-size: 22px;
            font-weight: bold;
            text-align: center;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            border: 3px solid #8d0707;
            /* Tom um pouco mais escuro para dar contraste */
        }

        #message::before {
            content: "‚ö†Ô∏è Aten√ß√£o! ";
            font-weight: bold;
            display: block;
            font-size: 24px;
            margin-bottom: 10px;
        }
    </style>
    <script>
        function updateProgress(sectionId) {
            let progressCircles = document.querySelectorAll('.progress div');
            let sectionIndex = Array.from(document.querySelectorAll('.section')).findIndex(section => section.id === sectionId);
            progressCircles.forEach((circle, index) => {
                circle.classList.toggle('active', index === sectionIndex);
            });
        }
    </script>
</head>

<body>
    <form id="userForm">
        <div class="progress">
            <div class="active" onclick="updateProgress('dados-pessoais')">1</div>
            <div onclick="updateProgress('endereco')">2</div>
            <div onclick="updateProgress('dados-saude')">3</div>
            <div onclick="updateProgress('dados-turma')">4</div>
            <div onclick="updateProgress('documentacao')">5</div>
        </div>

        <div class="container">
            <h2>Matr√≠cula 2025</h2>

            <label for="tipoMatricula">Tipo de matr√≠cula</label>
            <input type="text" id="tipoMatricula" name="tipomatricula" placeholder="Informe o tipo da matr√≠cula"
                value="{{ $json.query.tipo_de_matricula }}" readonly>
            <label for="proximonivel" style="display: none;">Pr√≥ximo N√≠vel</label>
            <input type="text" id="proximonivel" placeholder="Pr√≥ximo N√≠vel" value="{{ $json.query.nivel }}"
                style="display: none;" readonly>

            <div class="section" id="dados-pessoais" onfocusin="updateProgress('dados-pessoais')">
                <h3><i class="fas fa-user"></i> Dados Pessoais</h3>
                <label for="cpf">CPF</label>
                <input type="text" id="cpf" name="cpf_aluno" placeholder="Digite o CPF" value="{{ $json.query.cpf }}"
                    onblur="buscarNome()">
                <label for="nome">Nome</label>
                <input type="text" id="nomeCompleto" name="nome" required pattern="[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø\s]+"
                    oninput="this.value = this.value.replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø\s]/g, '')"
                    vaue="{{ $json.query.nome }}">
                <label for="datanascimento">Data de nascimento</label>
                <input type="date" id="datanascimento" name="data_nasc" placeholder="Informe a data de nascimento"
                    onchange="calcularIdade(); buscarFaixaetaria()">
                <label for="idade">Idade</label>
                <input type="number" id="idade" name="idade" placeholder="Informe a sua idade" readonly>
                <label for="faixaetaria">Faixa et√°ria</label>
                <input type="text" id="faixaetaria" name="faixa_etaria" placeholder="Faixa et√°ria" readonly>

                <label for="cpfresponsavel" style="display: none;">CPF do respons√°vel</label>
                <input type="text" id="cpfresponsavel" name="cpf_responsavel" placeholder="Digite o CPF do respons√°vel"
                    onblur="buscarNomeResponsavel()" style="display: none;">
                <label for="nomeresponsavel" style="display: none;">Nome do respons√°vel</label>
                <input type="text" id="nomeCompletoResponsavel" name="nome_responsavel_legal" required
                    pattern="[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø\s]+"
                    oninput="this.value = this.value.replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø\s]/g, '')" vaue="{{ $json.query.nome }}"
                    style="display: none;">


                <label for="racacor">Ra√ßa/Cor</label>
                <select id="racacor" name="raca_cor">
                    <option value="selecione"> </option>
                    <option value="amarela">Amarela</option>
                    <option value="branca">Branca</option>
                    <option value="indigena">Ind√≠gena</option>
                    <option value="parda">Parda</option>
                    <option value="preta">Preta</option>
                    <option value="naoinformar">Prefiro n√£o informar</option>
                </select>


                <label for="genero">G√™nero</label>
                <select id="genero" name="genero">
                    <option value="selecione"> </option>
                    <option value="feminino">Feminino</option>
                    <option value="masculino">Masculino</option>
                    <option value="naoinformar">Prefiro n√£o informar</option>
                </select>
            </div>

            <div class="section" id="endereco" onfocusin="updateProgress('endereco')">
                <h3><i class="fas fa-map-marker-alt"></i> Endere√ßo</h3>
                <label for="cep">CEP</label>
                <input type="text" id="cep" name="cep" required maxlength="8"
                    oninput="this.value = this.value.replace(/\D/g, '')" onchange="buscarEndereco()">
                <label for="logradouro">Logradouro</label>
                <input type="text" id="logradouro" name="logradouro" placeholder="Digite o nome da Rua/AV/Estrada">
                <label for="numero">N√∫mero</label>
                <input type="text" id="numero" name="numero" placeholder="Digite o n√∫mero">
                <label for="complemento">Complemento</label>
                <input type="text" id="complemento" name="complemento" placeholder="Digite o complemento">
                <label for="bairro">Bairro</label>
                <input type="text" id="bairro" name="bairro" placeholder="Digite seu bairro">
                <label for="cidade">Cidade</label>
                <input type="text" id="cidade" name="cidade" placeholder="Digite sua cidade">
                <label for="email">E-mail</label>
                <input type="email" id="email" name="email" placeholder="Digite seu e-mail">
                <label for="confirmarEmail">Confirme seu E-mail</label>
                <input type="email" id="confirmarEmail" placeholder="Confirme seu e-mail">
                <label for="whatsapp">WhatsApp</label>
                <input type="text" id="whatsapp" name="telefone"
                    placeholder="Digite seu n√∫mero de WhatsApp (11 d√≠gitos)">
                <label for="confirmarWhatsApp">Confirme seu n√∫mero de Whatsapp</label>
                <input type="text" id="confirmarWhatsApp" placeholder="Confirme seu WhatsApp">

            </div>

            <div class="section" id="dados-saude" onfocusin="updateProgress('dados-saude')">
                <h3><i class="fas fa-heartbeat"></i> Dados de Sa√∫de</h3>
                <label for="deficiencia">√â pessoa com defici√™ncia (PCD)?</label>
                <select id="pcd_ask" name="pcd_ask">
                    <option value="selecione"> </option>
                    <option value="nao">N√£o</option>
                    <option value="sim">Sim</option>
                </select>
                <label for="tipodeficiencia">Qual o tipo de defici√™ncia?</label>
                <select id="tipo_def_ask" name="tipo_pcd_ask">
                    <option value="selecione"> </option>
                    <option value="auditiva">Auditiva</option>
                    <option value="fisica_motora">F√≠sica/motora</option>
                    <option value="intelectual">Intelectual</option>
                    <option value="visao">Visual</option>
                </select>
                <label for="qualdeficiencia">Qual a defici√™ncia?</label>
                <select id="qual_deficiencia_ask" name="qual_deficiencia_ask">
                </select>

                <label for="contraindicacao_medica_ask">Possui alguma contraindica√ß√£o m√©dica para a pr√°tica de atividade
                    f√≠sica ou doen√ßa cr√¥nica?</label>
                <select id="contraindicacao_medica_ask" name="contraindicacao_medica_ask">
                    <option value="selecione"> </option>
                    <option value="nao">N√£o</option>
                    <option value="sim">Sim</option>
                </select>
                <label for="qual_contraindicacao_ask" style="display: none;">Qual √© a contraindica√ß√£o ou doen√ßa
                    cr√¥nica?</label>
                <input type="text" id="qual_contraindicacao_ask" name="qual_contraindicacao_ask"
                    placeholder="Informe qual a contra-indica√ß√£o" style="display: none;">

                <label for="realiza_atv_ask">Realiza alguma atividade f√≠sica?</label>
                <select id="realiza_atv_ask" name="realiza_atv_ask">
                    <option value="selecione"> </option>
                    <option value="nao">N√£o</option>
                    <option value="sim">Sim</option>
                </select>
                <label for="descreva_atv_ask" style="display: none;">Descreva a atividade</label>
                <input type="text" id="descreva_atv_ask" name="descreva_atv_ask" placeholder="Descreva a atividade"
                    style="display: none;">

                <label for="usa_mediamento_ask">Faz uso cont√≠nuo de algum medicamento?</label>
                <select id="usa_mediamento_ask" name="usa_medicamento_ask">
                    <option value="selecione"> </option>
                    <option value="nao">N√£o</option>
                    <option value="sim">Sim</option>
                </select>
                <label for="descreva_medicamento_ask" style="display: none;">Descreva quais medicamentos</label>
                <input type="text" id="descreva_medicamento_ask" name="descreva_medicamento_ask"
                    placeholder="Descreva medicamentos" style="display: none;">

                <label for="alergia_ask">Possui alguma alergia ou contraindica√ß√£o ao uso de algum medicamento?</label>
                <select id="alergia_ask" name="alergia_ask">
                    <option value="selecione"> </option>
                    <option value="nao">N√£o</option>
                    <option value="sim">Sim</option>
                </select>
                <label for="descreva_alergia_ask" style="display: none;">Descreva qual a alergia ou contraindica√ß√£o ao
                    uso
                    de algum medicamento</label>
                <input type="text" id="descreva_alergia_ask" name="descreva_alergia_ask" placeholder="Descreva alergias"
                    style="display: none;">
            </div>

            <div class="section" id="dados-turma" onfocusin="updateProgress('dados-turma')">
                <h3><i class="fas fa-music"></i> Dados da Turma</h3>
                <label for="modalidade">Modalidade</label>
                <input type="text" id="modalidade" name="modalidade" placeholder="Modalidade" readonly>
                <label for="nivel">N√≠vel</label>
                <select id="nivel" name="nivel">
                    <option value="">Selecione o nivel</option>
                    <option value="nivel1">Livre</option>
                    <option value="nivel2">Iniciante</option>
                    <option value="nivel2">Intermedi√°rio</option>
                </select>
                <label for="turma">Turma</label>
                <select id="turma" name="turma" onchange="preencherDetalhesTurma()">
                    <option value="">Selecione a turma</option>
                </select>

                <label for="dias">Dias</label>
                <input type="text" id="dias" name="dias" readonly>

                <label for="horario">Hor√°rio</label>
                <input type="text" id="horario" name="horario" readonly>

                <label for="local">Sala</label>
                <input type="text" id="local" name="sala" readonly>

                <label for="professor">Professor</label>
                <input type="text" id="professor" name="professor" readonly>
            </div>

            <div class="section" id="documentacao" onfocusin="updateProgress('documentacao')">
                <h3><i class="fas fa-file-alt"></i> Documenta√ß√£o</h3>
                <label for="possuirg">Possui RG:</label>
                <select id="possuirg" name="possuirg">                    
                <option value=""></option>
                <option value="sim">Sim</option>
                <option value="nao">N√£o</option>
                </select>
                <label for="rg_frente" style="display: none;">Anexar RG/CNH frente</label>
                <input type="file" id="rg_frente" name="rg_frente" style="display: none;">
                <label for="rg_verso" style="display: none;">Anexar RG/CNH verso</label>
                <input type="file" id="rg_verso" name="rg_verso" style="display: none;">
                <label for="certidaonascimento" style="display: none;">Anexar certid√£o de nascimento</label>
                <input type="file" id="certidao_nasc" name="certidao_nasc" style="display: none;">
                <label for="parecer_medico">Anexar laudo m√©dico</label>
                <input type="file" id="parecer_medico" name="parecer_medico">
            </div>
            <div>
                <button class="button" id="submitButton">Enviar Matr√≠cula</button>
            </div>
        </div>

        <div id="message" style="display: none;">
            A Escola de Frevo do Recife destina-se a alunos com idade m√≠nima completa de 6 anos. Voc√™ j√° pode fechar
            esta
            janela.
        </div>
    </form>
    <script>
        function toggleFields() {
            var rgSelect = document.getElementById("possuirg");
            var rgFrente = document.getElementById("rg_frente");
            var rgVerso = document.getElementById("rg_verso");
            var certidaoNasc = document.getElementById("certidao_nasc");
            var labelRgFrente = document.getElementById("label_rg_frente");
            var labelRgVerso = document.getElementById("label_rg_verso");
            var labelCertidaoNasc = document.getElementById("label_certidao_nasc");
        
            if (rgSelect.value === "Sim") {
              // Mostrar RG campos
              rgFrente.style.display = "inline";
              rgVerso.style.display = "inline";
              labelRgFrente.style.display = "inline";
              labelRgVerso.style.display = "inline";
              
              // Ocultar certid√£o de nascimento
              certidaoNasc.style.display = "none";
              labelCertidaoNasc.style.display = "none";
            } else {
              // Ocultar RG campos
              rgFrente.style.display = "none";
              rgVerso.style.display = "none";
              labelRgFrente.style.display = "none";
              labelRgVerso.style.display = "none";
        
              // Mostrar certid√£o de nascimento
              certidaoNasc.style.display = "inline";
              labelCertidaoNasc.style.display = "inline";
            }
          }

        document.addEventListener("DOMContentLoaded", function () {
            const camposMaiusculos = [
                "nomeCompleto",
                "nomeCompletoResponsavel",
                "logradouro",
                "complemento",
                "bairro",
                "cidade",
                "qual_contraindicacao_ask",
                "descreva_atv_ask",
                "descreva_medicamento_ask",
                "descreva_alergia_ask"
            ];

            const camposMinusculos = [
                "email",
                "confirmarEmail"
            ];

            function forcarMaiusculas(event) {
                event.target.value = event.target.value.toUpperCase();
            }

            function forcarMinusculas(event) {
                event.target.value = event.target.value.toLowerCase();
            }

            // Aplica o evento de input para converter os campos para mai√∫sculas
            camposMaiusculos.forEach(id => {
                let campo = document.getElementById(id);
                if (campo) {
                    campo.addEventListener("input", forcarMaiusculas);
                } else {
                    console.warn(`‚ö†Ô∏è Campo n√£o encontrado: ${id}`);
                }
            });

            // Aplica o evento de input para converter o campo email para min√∫sculas
            camposMinusculos.forEach(id => {
                let campo = document.getElementById(id);
                if (campo) {
                    campo.addEventListener("input", forcarMinusculas);
                } else {
                    console.warn(`‚ö†Ô∏è Campo n√£o encontrado: ${id}`);
                }
            });
        });

        document.addEventListener("DOMContentLoaded", function () {
            let cpfInput = document.getElementById("cpf");
            let cpfLabel = document.querySelector("label[for='cpf']"); // Captura o r√≥tulo do CPF
            let nomeInput = document.getElementById("nomeCompleto");

            if (cpfInput.value.trim() !== "") {
                // CPF preenchido: Ocultar o campo e buscar o nome
                cpfInput.setAttribute("readonly", "true");
                cpfInput.style.display = "none"; // Oculta o campo CPF
                if (cpfLabel) cpfLabel.style.display = "none"; // Oculta o r√≥tulo do CPF
                buscarNome();
            } else {
                // CPF vazio: Exibir o campo e permitir edi√ß√£o
                cpfInput.removeAttribute("readonly");
                cpfInput.style.display = ""; // Remove qualquer oculta√ß√£o
                if (cpfLabel) cpfLabel.style.display = ""; // Remove oculta√ß√£o do r√≥tulo
            }

            // Se o Nome estiver preenchido, bloquear o campo
            if (nomeInput.value.trim() !== "") {
                nomeInput.setAttribute("readonly", "true");
            }
        });

        //busca o nome a partir do cpf
        function buscarNome() {
            let cpf = document.getElementById("cpf").value.trim();
            let nomeInput = document.getElementById("nomeCompleto");

            if (cpf.length === 11) {
                axios.post("https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/buscar-pessoa", { cpf })
                    .then(response => {
                        if (response.data.nome) {
                            nomeInput.value = response.data.nome;
                            nomeInput.setAttribute("readonly", "true"); // Bloquear o campo Nome ap√≥s preenchimento
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao buscar nome:", error);
                    });
            }
        }

        //idade e faixa et√°ria
        document.addEventListener("DOMContentLoaded", function () {
            function calcularIdade() {
                console.log("‚ñ∂Ô∏è Fun√ß√£o calcularIdade() chamada");

                let hoje = new Date();
                let nascimentoInput = document.getElementById("datanascimento");
                let idadeInput = document.getElementById("idade");
                let nascimento = new Date(nascimentoInput.value);

                if (!isNaN(nascimento) && nascimentoInput.value !== "") {
                    let idade = hoje.getFullYear() - nascimento.getFullYear();
                    let mes = hoje.getMonth() - nascimento.getMonth();
                    if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
                        idade--;
                    }
                    idadeInput.value = idade;

                    console.log("üîπ Idade calculada:", idade);

                    // Se a idade for menor que 6, interrompe a execu√ß√£o IMEDIATAMENTE
                    if (!verificarIdadeMinima(idade)) {
                        return;
                    }

                    // Se a idade for v√°lida, continua o restante do c√≥digo normalmente
                    buscarFaixaetaria();
                    verificarResponsavel(idade);
                } else {
                    idadeInput.value = "";
                }
            }

            function verificarIdadeMinima(idade) {
                console.log("‚ñ∂Ô∏è Fun√ß√£o verificarIdadeMinima() chamada com idade:", idade);

                let container = document.querySelector(".container");
                let progressBar = document.querySelector(".progress"); // Captura a barra de progresso
                let messageDiv = document.getElementById("message"); // Captura a mensagem

                let dataNascimentoInput = document.getElementById("datanascimento");
                let idadeInput = document.getElementById("idade");
                let faixaEtariaInput = document.getElementById("faixaetaria");

                if (idade < 6) {
                    console.log("‚ö†Ô∏è Idade menor que 6 detectada. Exibindo popup...");

                    let confirmacao = window.confirm(
                        "A Escola de Frevo do Recife destina-se a alunos com idade m√≠nima completa de 6 anos.\n\n" +
                        "Clique em 'OK' para fechar o formul√°rio.\n" +
                        "Clique em 'Cancelar' para limpar a data de nascimento e informar uma nova data."
                    );

                    if (confirmacao) {
                        console.log("‚úÖ Usu√°rio clicou em OK - Ocultando formul√°rio e exibindo mensagem na tela...");

                        // Oculta o formul√°rio e a barra de progresso
                        container.style.display = "none";
                        progressBar.style.display = "none";

                        // Exibe a mensagem na tela
                        messageDiv.innerHTML = "A Escola de Frevo do Recife destina-se a alunos com idade m√≠nima completa de 6 anos.";
                        messageDiv.style.display = "block";

                    } else {
                        console.log("‚ùå Usu√°rio clicou em Cancelar - Limpando campos...");
                        dataNascimentoInput.value = "";
                        idadeInput.value = "";
                        faixaEtariaInput.value = "";

                        // Mant√©m o formul√°rio e a barra de progresso vis√≠veis
                        container.style.display = "block";
                        progressBar.style.display = "flex";

                        // Esconde a mensagem da tela
                        messageDiv.style.display = "none";
                    }

                    return false; // INTERROMPE QUALQUER OUTRA EXECU√á√ÉO
                }

                console.log("‚úÖ Idade permitida, mantendo formul√°rio vis√≠vel.");
                container.style.display = "block"; // Exibe o formul√°rio normalmente se a idade for >= 6
                progressBar.style.display = "flex"; // Garante que a barra de progresso tamb√©m aparece
                messageDiv.style.display = "none"; // Esconde a mensagem se o aluno for v√°lido
                return true; // Permite que o c√≥digo continue
            }

            function buscarFaixaetaria() {
                let idadeInput = document.getElementById("idade").value.trim();

                if (idadeInput !== "") {
                    console.log("‚ñ∂Ô∏è Fun√ß√£o buscarFaixaetaria() chamada com idade:", idadeInput);

                    axios.post("https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/modalidade", { idade: idadeInput })
                        .then(response => {
                            console.log("üü¢ Resposta recebida do webhook:", response.data);

                            if (Array.isArray(response.data) && response.data.length > 0) {
                                let resultado = response.data[0];

                                if (resultado.faixa_etaria) {
                                    document.getElementById("faixaetaria").value = resultado.faixa_etaria;
                                    console.log("‚úÖ Campo Faixa Et√°ria atualizado:", resultado.faixa_etaria);
                                }

                                if (resultado.modalidade) {
                                    document.getElementById("modalidade").value = resultado.modalidade;
                                    console.log("‚úÖ Campo Modalidade atualizado:", resultado.modalidade);
                                }
                            } else {
                                console.warn("‚ö†Ô∏è Resposta inesperada do webhook:", response.data);
                            }
                        })
                        .catch(error => {
                            console.error("‚õî Erro ao consultar faixa et√°ria e modalidade:", error);
                        });
                } else {
                    console.warn("‚ö†Ô∏è Nenhuma idade informada. A consulta n√£o foi realizada.");
                }
            }

            function verificarResponsavel(idade) {
                console.log("‚ñ∂Ô∏è Fun√ß√£o verificarResponsavel() chamada com idade:", idade);

                const cpfResponsavelLabel = document.querySelector("label[for='cpfresponsavel']");
                const cpfResponsavel = document.getElementById("cpfresponsavel");
                const nomeResponsavelLabel = document.querySelector("label[for='nomeresponsavel']");
                const nomeResponsavel = document.getElementById("nomeCompletoResponsavel");

                if (idade < 18) {
                    console.log("üîπ Idade menor que 18 - Exibindo campos do respons√°vel.");
                    cpfResponsavelLabel.style.display = "block";
                    cpfResponsavel.style.display = "block";
                    cpfResponsavel.setAttribute("required", "required");

                    nomeResponsavelLabel.style.display = "block";
                    nomeResponsavel.style.display = "block";
                    nomeResponsavel.setAttribute("required", "required");
                } else {
                    console.log("üîπ Idade maior ou igual a 18 - Ocultando campos do respons√°vel.");
                    cpfResponsavelLabel.style.display = "none";
                    cpfResponsavel.style.display = "none";
                    cpfResponsavel.removeAttribute("required");
                    cpfResponsavel.value = ""; // Limpa o campo ao ocult√°-lo

                    nomeResponsavelLabel.style.display = "none";
                    nomeResponsavel.style.display = "none";
                    nomeResponsavel.removeAttribute("required");
                    nomeResponsavel.value = ""; // Limpa o campo ao ocult√°-lo
                }
            }

            // ‚¨áÔ∏è EXECUTA SOMENTE AP√ìS O USU√ÅRIO SAIR DO CAMPO (BLUR)
            document.getElementById("datanascimento").addEventListener("blur", calcularIdade);

            document.getElementById("cpfresponsavel").addEventListener("input", function () {
                this.value = this.value.replace(/\D/g, ""); // Remove caracteres n√£o num√©ricos
                if (this.value.length > 11) {
                    this.value = this.value.slice(0, 11); // Limita a 11 d√≠gitos
                }
            });

            document.getElementById("cpfresponsavel").addEventListener("blur", function () {
                if (this.value !== "" && this.value.length !== 11) { // Permite o campo vazio
                    alert("O CPF deve conter exatamente 11 d√≠gitos num√©ricos.");

                    // Aguarda o usu√°rio fechar o alerta antes de limpar o campo e restaurar o foco
                    setTimeout(() => {
                        this.value = "";
                        this.focus();
                    }, 100);
                }
            });

        });

        //Buscar nome do respons√°vel
        function buscarNomeResponsavel() {
            let cpfResponsavel = document.getElementById("cpfresponsavel").value.trim();
            let nomeResponsavelInput = document.getElementById("nomeCompletoResponsavel");

            if (cpfResponsavel.length === 11) {
                axios.post("https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/buscar-pessoa", { cpf: cpfResponsavel })
                    .then(response => {
                        if (response.data.nome) {
                            nomeResponsavelInput.value = response.data.nome;
                            nomeResponsavelInput.setAttribute("readonly", "true"); // Bloquear o campo Nome ap√≥s preenchimento
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao buscar nome do respons√°vel:", error);
                    });
            }
        }

        //Preencher endere√ßo
        function buscarEndereco() {
            let cep = document.getElementById("cep").value.trim();

            if (cep.length === 8) { // Garantir que o CEP tem 8 d√≠gitos
                // Chama a API ViaCEP
                axios.get(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(response => {
                        let data = response.data;

                        // Verifica se a API retornou um erro
                        if (!data.erro) {
                            // Preenche os campos de endere√ßo com os dados retornados
                            document.getElementById("logradouro").value = data.logradouro || "";
                            document.getElementById("bairro").value = data.bairro || "";
                            document.getElementById("cidade").value = data.localidade || "";
                            document.getElementById("complemento").value = data.complemento || "";

                            console.log("Endere√ßo preenchido com sucesso!");

                        } else {
                            alert("CEP inv√°lido. Verifique e tente novamente.");
                            console.error("Erro ao buscar o endere√ßo, CEP n√£o encontrado.");
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao buscar endere√ßo:", error);
                    });
            } else {
                alert("Por favor, insira um CEP v√°lido com 8 d√≠gitos.");
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            // üìß Valida√ß√£o e confirma√ß√£o do e-mail
            let emailInput = document.getElementById("email");
            let confirmarEmailInput = document.getElementById("confirmarEmail");

            emailInput.addEventListener("blur", function () {
                this.value = this.value.trim().toLowerCase(); // Converte para min√∫sculas

                let emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (this.value !== "" && !emailRegex.test(this.value)) {
                    alert("E-mail inv√°lido! Digite um endere√ßo v√°lido.");
                    this.value = "";
                }
            });

            confirmarEmailInput.addEventListener("blur", function () {
                if (this.value.trim() !== "" && this.value.trim().toLowerCase() !== emailInput.value.trim().toLowerCase()) {
                    alert("Os e-mails digitados n√£o coincidem. Verifique e corrija.");
                    setTimeout(() => confirmarEmailInput.focus(), 100); // Retorna o foco ap√≥s o alerta
                    this.value = ""; // Limpa o campo de confirma√ß√£o
                }
            });

            // üì± Valida√ß√£o e confirma√ß√£o do WhatsApp
            let whatsappInput = document.getElementById("whatsapp");
            let confirmarWhatsAppInput = document.getElementById("confirmarWhatsApp");

            function validarNumero(input) {
                input.value = input.value.replace(/\D/g, ""); // Remove tudo que n√£o for n√∫mero
                if (input.value.length > 11) {
                    input.value = input.value.slice(0, 11); // Limita a 11 d√≠gitos
                }
            }

            whatsappInput.addEventListener("input", function () {
                validarNumero(this);
            });

            whatsappInput.addEventListener("blur", function () {
                if (this.value.trim() !== "" && this.value.length !== 11) {
                    alert("O WhatsApp deve conter exatamente 11 d√≠gitos num√©ricos.");
                    this.value = "";
                }
            });

            confirmarWhatsAppInput.addEventListener("input", function () {
                validarNumero(this);
            });

            confirmarWhatsAppInput.addEventListener("blur", function () {
                if (this.value.trim() !== "" && this.value !== whatsappInput.value) {
                    alert("Os n√∫meros de WhatsApp digitados n√£o coincidem. Verifique e corrija.");
                    setTimeout(() => confirmarWhatsAppInput.focus(), 100); // Retorna o foco ap√≥s o alerta
                    this.value = ""; // Limpa o campo de confirma√ß√£o
                }
            });
        });

        //verificar se tipo de matr√≠cula √© inv√°lido
        function verificarTipoMatricula() {
            let tipoMatriculaInput = document.getElementById("tipoMatricula");

            if (!tipoMatriculaInput) {
                console.error("O campo 'tipoMatricula' n√£o foi encontrado no DOM.");
                return "";
            }

            let tipoMatriculaValue = tipoMatriculaInput.value.trim();

            if (!tipoMatriculaValue || tipoMatriculaValue === "{{ $json.query.tipo_matricula }}") {
                console.warn("Tipo de Matr√≠cula inv√°lido ou n√£o carregado, assumindo 'Matr√≠cula nova'.");
                tipoMatriculaInput.value = "Matr√≠cula nova"; // Define um valor padr√£o caso esteja vazio
            }

            return tipoMatriculaInput.value.trim();
        }

        //Define os niveis a partir do tipo de matr√≠cula
        document.addEventListener("DOMContentLoaded", function () {
            setTimeout(() => {
                let tipoMatriculaInput = document.getElementById("tipoMatricula");
                let nivelSelect = document.getElementById("nivel");
                let proximoNivelInput = document.getElementById("proximonivel");

                if (!tipoMatriculaInput || !nivelSelect || !proximoNivelInput) {
                    console.error("‚ùå Um dos elementos n√£o foi encontrado no DOM.");
                    return;
                }

                let tipoMatriculaValue = tipoMatriculaInput.value ? tipoMatriculaInput.value.trim() : "Matr√≠cula nova";
                let proximoNivelValue = proximoNivelInput.value.trim();

                // Se `tipoMatricula` estiver indefinido ou vazio, definir como "Matr√≠cula nova" e limpar `proximoNivel`
                if (!tipoMatriculaInput.value || tipoMatriculaInput.value.trim() === "undefined") {
                    console.warn("‚ö†Ô∏è tipoMatricula estava indefinido. Definindo como 'Matr√≠cula nova'.");
                    tipoMatriculaInput.value = "Matr√≠cula nova";
                    proximoNivelInput.value = ""; // Limpa o campo proximoNivel
                }

                console.log("üîπ Tipo de Matr√≠cula carregado:", tipoMatriculaInput.value);
                console.log("üîπ Pr√≥ximo N√≠vel carregado:", proximoNivelInput.value);

                atualizarNiveis(tipoMatriculaInput.value, proximoNivelInput.value);
            }, 300); // Pequeno delay para garantir que os valores foram carregados
        });

        // Fun√ß√£o para atualizar as op√ß√µes do select n√≠vel com base no tipo de matr√≠cula
        function atualizarNiveis(tipoMatricula, proximoNivel) {
            let nivelSelect = document.getElementById("nivel");

            if (!nivelSelect) {
                console.error("‚ùå O campo 'nivel' n√£o foi encontrado no DOM.");
                return;
            }

            nivelSelect.innerHTML = ""; // Limpa as op√ß√µes

            if (tipoMatricula === "Matr√≠cula nova") {
                console.log("üìå Configurando n√≠veis para 'Matr√≠cula nova'");
                nivelSelect.innerHTML = `
                    <option value="">Selecione o n√≠vel</option>
                    <option value="Livre">Livre</option>
                    <option value="Iniciante">Iniciante</option>
                `;
                nivelSelect.disabled = false; // Mant√©m edit√°vel
            } else if (tipoMatricula === "Renova√ß√£o" && proximoNivel) {
                console.log("üìå Configurando n√≠vel √∫nico para 'Renova√ß√£o':", proximoNivel);
                nivelSelect.innerHTML = `<option value="${proximoNivel}" selected>${proximoNivel}</option>`;
                nivelSelect.disabled = true; // Bloqueia edi√ß√£o
            }
        }

        // üîπ Buscar turmas
        function buscarTurmas() {
            let faixaEtariaInput = document.getElementById("faixaetaria");
            let nivelSelect = document.getElementById("nivel");
            let proximoNivelInput = document.getElementById("proximonivel");
            let tipoMatriculaInput = document.getElementById("tipoMatricula");

            if (!faixaEtariaInput || !nivelSelect || !proximoNivelInput || !tipoMatriculaInput) {
                console.error("‚ùå Um ou mais elementos n√£o foram encontrados no DOM.");
                return;
            }

            let faixaEtaria = faixaEtariaInput.value.trim();
            let tipoMatricula = tipoMatriculaInput.value.trim();
            let nivel = "";

            // üîπ Define o n√≠vel corretamente para o webhook
            if (tipoMatricula === "Matr√≠cula nova") {
                nivel = nivelSelect.options[nivelSelect.selectedIndex].text; // Obt√©m o TEXTO vis√≠vel do option
            } else if (tipoMatricula === "Renova√ß√£o" && proximoNivelInput.value.trim()) {
                nivel = proximoNivelInput.value.trim();
            }

            console.log("üîπ Chamando Webhook para buscar turmas...");
            console.log("Faixa Et√°ria:", faixaEtaria || "Valor n√£o encontrado!");
            console.log("N√≠vel enviado:", nivel || "Valor n√£o encontrado!");
            console.log("Tipo de Matr√≠cula:", tipoMatricula || "Valor n√£o encontrado!");

            if (!faixaEtaria || !nivel) {
                console.warn("‚ö†Ô∏è Faixa et√°ria ou n√≠vel est√° vazio. A consulta n√£o ser√° realizada.");
                return;
            }

            axios.post("https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/turmas-frevo-consulta", {
                faixa_etaria: faixaEtaria,
                nivel: nivel, // Enviando o TEXTO vis√≠vel
                tipo_de_matricula: tipoMatricula
            })
                .then(response => {
                    console.log("üü¢ Resposta do Webhook:", response.data);

                    let selectTurma = document.getElementById("turma");
                    selectTurma.innerHTML = '<option value="">Selecione a turma</option>'; // Limpa as op√ß√µes

                    if (Array.isArray(response.data) && response.data.length > 0) {
                        turmasData = response.data; // Armazena os dados das turmas
                        turmasData.forEach(item => {
                            let option = document.createElement("option");
                            option.value = item.turma;
                            option.textContent = `${item.turma} - ${item.dias} (${item.horario}) - ${item.local} - Prof. ${item.professor}`;
                            selectTurma.appendChild(option);
                        });
                    } else {
                        console.warn("‚ö†Ô∏è Nenhuma turma encontrada.");
                    }
                })
                .catch(error => {
                    console.error("‚õî Erro ao buscar turmas:", error);
                });
        }

        // üîµ Atualizar a lista de n√≠veis sempre que o `tipoMatricula` mudar
        document.getElementById("tipoMatricula").addEventListener("change", function () {
            let tipoMatricula = this.value.trim();
            let proximoNivel = document.getElementById("proximonivel").value.trim();

            // Se for "Matr√≠cula nova", limpar `proximoNivel`
            if (tipoMatricula === "Matr√≠cula nova") {
                document.getElementById("proximonivel").value = "";
            }

            atualizarNiveis(tipoMatricula, proximoNivel);
        });

        // üîπ Chamar `buscarTurmas` quando n√≠vel ou data de nascimento mudarem
        document.getElementById("datanascimento").addEventListener("blur", function () {
            buscarTurmas();
        });

        document.getElementById("nivel").addEventListener("change", function () {
            limparCamposTurma(); // Limpa os campos da turma sempre que o n√≠vel for alterado
            buscarTurmas();
        });

        // üîπ Fun√ß√£o para limpar os campos da turma ao alterar o n√≠vel
        function limparCamposTurma() {
            console.log("üßπ Limpando campos de turma...");
            document.getElementById("turma").innerHTML = '<option value="">Selecione a turma</option>';
            document.getElementById("dias").value = "";
            document.getElementById("horario").value = "";
            document.getElementById("local").value = "";
            document.getElementById("professor").value = "";
        }

        // üîπ Preencher detalhes da turma ao selecionar uma op√ß√£o
        function preencherDetalhesTurma() {
            let turmaSelecionada = document.getElementById("turma").value;
            let turmaInfo = turmasData.find(turma => turma.turma === turmaSelecionada);

            if (turmaInfo) {
                document.getElementById("dias").value = turmaInfo.dias;
                document.getElementById("horario").value = turmaInfo.horario;
                document.getElementById("local").value = turmaInfo.local;
                document.getElementById("professor").value = turmaInfo.professor;
            } else {
                limparCamposTurma();
            }
        }

        document.getElementById("turma").addEventListener("change", preencherDetalhesTurma);


        document.addEventListener("DOMContentLoaded", function () {
            let nivel = document.getElementById("nivel").value.trim();
            console.log("N√≠vel ao carregar:", nivel);

            if (nivel) {
                document.getElementById("datanascimento").addEventListener("blur", buscarTurmas);
            }
        });

        //Transporta dados do respons√°vel caso maior de idade e deficiente intelectual
        document.addEventListener("DOMContentLoaded", function () {
            const tipoDeficiencia = document.getElementById("tipo_def_ask");
            const pcdAsk = document.getElementById("pcd_ask");
            const dadosPessoais = document.getElementById("dados-pessoais");
            const dadosSaude = document.getElementById("dados-saude");

            const cpfResponsavelLabel = document.querySelector("label[for='cpfresponsavel']");
            const cpfResponsavel = document.getElementById("cpfresponsavel");
            const nomeResponsavelLabel = document.querySelector("label[for='nomeresponsavel']");
            const nomeResponsavel = document.getElementById("nomeCompletoResponsavel");

            function verificarMovimentacaoCampos() {
                let idade = parseInt(document.getElementById("idade").value) || 0;

                if (idade < 18) {
                    // Se idade < 18, mant√©m os campos em "Dados Pessoais"
                    if (!dadosPessoais.contains(cpfResponsavel)) {
                        dadosPessoais.appendChild(cpfResponsavelLabel);
                        dadosPessoais.appendChild(cpfResponsavel);
                        dadosPessoais.appendChild(nomeResponsavelLabel);
                        dadosPessoais.appendChild(nomeResponsavel);
                    }
                    cpfResponsavelLabel.style.display = "block";
                    cpfResponsavel.style.display = "block";
                    cpfResponsavel.setAttribute("required", "required");

                    nomeResponsavelLabel.style.display = "block";
                    nomeResponsavel.style.display = "block";
                    nomeResponsavel.setAttribute("required", "required");
                } else {
                    // Se idade >= 18 e "intelectual" for selecionado, move para "Dados de Sa√∫de"
                    if (tipoDeficiencia.value === "intelectual" && pcdAsk.value === "sim") {
                        if (!dadosSaude.contains(cpfResponsavel)) {
                            dadosSaude.appendChild(cpfResponsavelLabel);
                            dadosSaude.appendChild(cpfResponsavel);
                            dadosSaude.appendChild(nomeResponsavelLabel);
                            dadosSaude.appendChild(nomeResponsavel);
                        }
                        cpfResponsavelLabel.style.display = "block";
                        cpfResponsavel.style.display = "block";
                        cpfResponsavel.setAttribute("required", "required");

                        nomeResponsavelLabel.style.display = "block";
                        nomeResponsavel.style.display = "block";
                        nomeResponsavel.setAttribute("required", "required");
                    } else {
                        // Se outra defici√™ncia for selecionada ou "PCD" for "N√£o", oculta os campos
                        ocultarCamposResponsavel();
                    }
                }
            }

            function ocultarCamposResponsavel() {
                cpfResponsavelLabel.style.display = "none";
                cpfResponsavel.style.display = "none";
                cpfResponsavel.removeAttribute("required");
                cpfResponsavel.value = "";

                nomeResponsavelLabel.style.display = "none";
                nomeResponsavel.style.display = "none";
                nomeResponsavel.removeAttribute("required");
                nomeResponsavel.value = "";
            }

            // Verifica mudan√ßas no select "PCD"
            pcdAsk.addEventListener("change", function () {
                if (pcdAsk.value === "nao") {
                    ocultarCamposResponsavel();
                } else {
                    verificarMovimentacaoCampos();
                }
            });

            // Chama a fun√ß√£o ao mudar o tipo de defici√™ncia
            tipoDeficiencia.addEventListener("change", verificarMovimentacaoCampos);

            // Chama a fun√ß√£o ao sair do campo Data de Nascimento
            document.getElementById("datanascimento").addEventListener("change", function () {
                setTimeout(verificarMovimentacaoCampos, 100);
            });
        });

        // Disparar a busca ao sair (`blur`) ou mudar (`change`) o campo n√≠vel
        document.getElementById("nivel").addEventListener("blur", function () {
            if (this.value.trim()) {
                buscarTurmas();
            }
        });

        document.getElementById("nivel").addEventListener("change", function () {
            if (this.value.trim()) {
                buscarTurmas();
            }
        });

        // Atualiza os detalhes da turma quando a sele√ß√£o muda
        document.getElementById("turma").addEventListener("change", preencherDetalhesTurma);

        //Defici√™ncia
        document.addEventListener("DOMContentLoaded", function () {
            const pcdAsk = document.getElementById("pcd_ask");
            const tipoPcdLabel = document.querySelector("label[for='tipodeficiencia']");
            const tipoPcdAsk = document.getElementById("tipo_def_ask");
            const qualDefLabel = document.querySelector("label[for='qualdeficiencia']");
            const qualDeficienciaAsk = document.getElementById("qual_deficiencia_ask");

            const deficiencias = {
                "auditiva": [
                    "",
                    "Defici√™ncia auditiva",
                    "Perda auditiva de grau leve a severo",
                    "Surdez bilateral, profunda",
                    "Surdez unilateral",
                    "Outras defici√™ncias auditivas"
                ],
                "visao": [
                    "",
                    "Baixa vis√£o",
                    "Cegueira total",
                    "Vis√£o monocular",
                    "Outras defici√™ncias visuais"
                ],
                "fisica_motora": [
                    "",
                    "Amputa√ß√£o ou aus√™ncia de membro",
                    "Hemiplegia",
                    "Nanismo",
                    "Ostomia",
                    "Paralisia cerebral",
                    "Paraparesia",
                    "Paraplegia",
                    "Tetraparesia",
                    "Tetraplegia",
                    "Outras defici√™ncias f√≠sicas"
                ],
                "intelectual": [
                    "",
                    "Depress√£o grave ou persistente",
                    "Esquizofrenia",
                    "S√≠ndrome de Down",
                    "Transtorno bipolar",
                    "Transtornos de personalidade",
                    "Transtorno do espectro do autismo",
                    "Outras defici√™ncias intelectuais"
                ]
            };

            // Fun√ß√£o para exibir/ocultar campos e definir obrigatoriedade
            function toggleField(select, label, field) {
                if (select.value === "sim") {
                    label.style.display = "block";
                    field.style.display = "block";
                    field.setAttribute("required", "required");
                } else {
                    label.style.display = "none";
                    field.style.display = "none";
                    field.removeAttribute("required");
                    field.value = ""; // Limpa o campo ao ocult√°-lo
                }
            }

            // Inicialmente esconde os labels e selects
            tipoPcdLabel.style.display = "none";
            tipoPcdAsk.style.display = "none";
            qualDefLabel.style.display = "none";
            qualDeficienciaAsk.style.display = "none";
            tipoPcdAsk.removeAttribute("required");
            qualDeficienciaAsk.removeAttribute("required");

            // Evento para mostrar/esconder o tipo de defici√™ncia
            pcdAsk.addEventListener("change", function () {
                toggleField(pcdAsk, tipoPcdLabel, tipoPcdAsk);
                // Se "n√£o", tamb√©m esconde e reseta o pr√≥ximo campo
                if (this.value !== "sim") {
                    qualDefLabel.style.display = "none";
                    qualDeficienciaAsk.style.display = "none";
                    qualDeficienciaAsk.innerHTML = "";
                    qualDeficienciaAsk.removeAttribute("required");
                }
            });

            // Evento para mostrar/esconder a lista de defici√™ncias espec√≠ficas
            tipoPcdAsk.addEventListener("change", function () {
                qualDeficienciaAsk.innerHTML = "";
                if (this.value !== "selecione") {
                    qualDefLabel.style.display = "block";
                    qualDeficienciaAsk.style.display = "block";
                    qualDeficienciaAsk.setAttribute("required", "required");

                    let options = deficiencias[this.value];
                    options.forEach(option => {
                        let opt = document.createElement("option");
                        opt.value = option.toLowerCase().replace(/\s+/g, "_");
                        opt.textContent = option;
                        qualDeficienciaAsk.appendChild(opt);
                    });
                } else {
                    qualDefLabel.style.display = "none";
                    qualDeficienciaAsk.style.display = "none";
                    qualDeficienciaAsk.removeAttribute("required");
                    qualDeficienciaAsk.innerHTML = ""; // Limpa op√ß√µes ao esconder
                }
            });
        });

        document.addEventListener("DOMContentLoaded", function () {
            function toggleField(selectId, labelId, inputId) {
                const select = document.getElementById(selectId);
                const label = document.querySelector(`label[for='${labelId}']`);
                const input = document.getElementById(inputId);

                label.style.display = "none";
                input.style.display = "none";
                input.removeAttribute("required"); // Remove required inicialmente

                select.addEventListener("change", function () {
                    if (this.value === "sim") {
                        label.style.display = "block";
                        input.style.display = "block";
                        input.setAttribute("required", "required"); // Torna obrigat√≥rio
                    } else {
                        label.style.display = "none";
                        input.style.display = "none";
                        input.removeAttribute("required"); // Remove obrigatoriedade
                        input.value = ""; // Limpa o campo ao ocult√°-lo
                    }
                });
            }

            toggleField("contraindicacao_medica_ask", "qual_contraindicacao_ask", "qual_contraindicacao_ask");
            toggleField("realiza_atv_ask", "descreva_atv_ask", "descreva_atv_ask");
            toggleField("usa_mediamento_ask", "descreva_medicamento_ask", "descreva_medicamento_ask");
            toggleField("alergia_ask", "descreva_alergia_ask", "descreva_alergia_ask");
        });

        function convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]); // Remove o prefixo "data:*/*;base64,"
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            const submitButton = document.getElementById("submitButton");
        
            if (submitButton) {
                submitButton.addEventListener("click", function (event) {
                    console.log("Bot√£o de enviar clicado");
        
                    let form = document.getElementById("userForm");
        
                    if (form) {
                        // Evita o envio padr√£o do formul√°rio
                        event.preventDefault();
        
                        // Construir o objeto de dados manualmente
                        let jsonData = {};
        
                        // Itera sobre todos os campos do formul√°rio e coleta seus valores
                        let fields = form.querySelectorAll("input, select, textarea");
                        fields.forEach(field => {
                            // Verifica se o campo tem valor e est√° habilitado
                            if (field.name && field.value !== undefined) {
                                // Se o campo for readonly ou com display: none, ainda ser√° enviado se tiver valor
                                jsonData[field.name] = field.value;
                            }
                        });
        
                        // Verifica se h√° campos de tipo 'file' no formul√°rio
                        let fileInputs = form.querySelectorAll("input[type='file']");
                        let filePromises = [];
        
                        fileInputs.forEach(fileInput => {
                            if (fileInput.files.length > 0) {
                                let file = fileInput.files[0];
        
                                // Adiciona a promessa de convers√£o para base64
                                filePromises.push(
                                    convertToBase64(file).then(base64File => {
                                        // Extrai a extens√£o do arquivo
                                        let fileExtension = file.name.split('.').pop();
        
                                        // Adiciona o arquivo convertido e a extens√£o ao JSON
                                        jsonData[`${fileInput.name}_base64`] = base64File; // Arquivo em base64
                                        jsonData[`${fileInput.name}_ext`] = fileExtension; // Extens√£o do arquivo
                                        console.log(`${fileInput.name} convertido para base64:`, base64File);
                                        console.log(`${fileInput.name} extens√£o:`, fileExtension);
                                    })
                                );
                            }
                        });
        
                        // Espera todas as promessas de arquivos terminarem
                        Promise.all(filePromises).then(() => {
                            // Envio via Axios
                            axios.post("https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/efr", jsonData, {
                                headers: { "Content-Type": "application/json" }
                            })
                            .then(response => {
                                console.log("Resposta do servidor:", response.data);
                                alert("Formul√°rio enviado com sucesso! Aguarde confirma√ß√£o.");
                                form.reset();
                            })
                            .catch(error => {
                                console.error("Erro ao enviar o formul√°rio:", error.response || error.message);
                                alert(error.message);
                            });
                        }).catch(error => {
                            console.error("Erro ao converter o arquivo para base64:", error);
                            alert("Erro ao processar o arquivo. Tente novamente.");
                        });
                    } else {
                        console.error("Formul√°rio n√£o encontrado!");
                    }
                });
            }
        });
        
    </script>

</body>

</html>
