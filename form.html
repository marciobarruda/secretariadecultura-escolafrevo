<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Secretaria da Cultura ‚Ä¢ Escola de Frevo</title>
    <link
      rel="icon"
      href="https://statics.recife.pe.gov.br/images/dynamics/conecta/icons/favicon.png?w=32&h=32&fit=fill&border=2,transparent,shrink"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      :root {
        --brand-primary: #004aad;
        --brand-secondary: #003579;
        --brand-highlight: #00a3ff;
        --surface: #ffffff;
        --surface-strong: #ffffff;
        --border-color: #d6deea;
        --text-strong: #1f2937;
        --text-muted: #4b5563;
      }

      *, *::before, *::after {
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", "Roboto", "Open Sans", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--surface);
        color: var(--text-strong);
        min-height: 100vh;
      }

      header.site-header {
        background: url("https://statics.recife.pe.gov.br/images/dynamics/automacao/header.png?w=3000")
          center/cover no-repeat;
        color: #ffffff;
        padding: 3.5rem 0 2.75rem;
      }

      header .lead {
        color: rgba(255, 255, 255, 0.9);
        max-width: 100%;
        font-size: 1rem;
        line-height: 1.65;
        text-align: justify;
      }

      .badge-open {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        font-weight: 600;
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        background-color: rgba(255, 255, 255, 0.14);
      }

      .user-greeting {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.05rem;
        font-weight: 500;
        margin-bottom: 2.5rem;
        padding: 1.2rem 1.6rem;
        border-radius: 18px;
        background: var(--surface-strong);
        color: var(--text-strong);
        border: 1px solid rgba(0, 83, 164, 0.12);
        box-shadow: 0 16px 34px rgba(0, 45, 98, 0.08);
      }

      .user-greeting::before {
        content: "üëã";
        font-size: 1.4rem;
      }

      .user-greeting strong {
        color: var(--brand-secondary);
      }

      .card {
        border-radius: 16px;
        overflow: hidden;
        border: none;
      }

      .rounded-4 {
        border-radius: 16px !important;
      }

      .card-programa {
        border: 1px solid rgba(0, 74, 173, 0.08);
        border-radius: 16px;
        background: var(--surface-strong);
        box-shadow: 0 12px 32px rgba(15, 37, 78, 0.08);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        height: 100%;
      }

      .card-programa:hover {
        transform: translateY(-4px);
        box-shadow: 0 18px 40px rgba(15, 37, 78, 0.12);
      }

      .card-programa .card-header {
        border-bottom: 1px solid rgba(0, 74, 173, 0.1);
        background: linear-gradient(180deg, #ffffff 0%, #f6f9ff 100%);
        padding: 1.5rem 1.5rem 1.2rem;
      }

      .card-programa .card-body {
        padding: 1.5rem;
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 700;
        font-size: 1.1rem;
        letter-spacing: 0.02em;
        color: var(--brand-primary);
      }

      .section-title::before {
        content: "";
        display: inline-block;
        width: 28px;
        height: 3px;
        border-radius: 999px;
        background: var(--brand-highlight);
      }

      .card-hero .card-body {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }

      .card-hero .card-tag {
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        color: #004aad;
        text-transform: uppercase;
      }

      .card-hero .card-title {
        font-size: 1.6rem;
        font-weight: 700;
        color: #004aad;
        margin: 0;
      }

      .card-hero .card-subtitle {
        font-size: 1rem;
        color: var(--text-muted);
        margin: 0;
      }

      .card-hero .card-list {
        padding-left: 1.1rem;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        color: var(--text-strong);
      }

      .card-hero .card-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .downloads-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.25rem;
      }

      .download-card {
        border: 1px solid var(--border-color);
        background: var(--surface-strong);
        border-radius: 4px;
        padding: 1.35rem 1.4rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        min-height: 170px;
      }

      .mapa-unidades-wrapper {
        border-radius: 12px;
        overflow: hidden;
        background: #f6f9ff;
      }

      .mapa-unidades-frame {
        border: 0;
        width: 100%;
        height: 100%;
      }

      .collapsible-form {
        border: 1px solid rgba(0, 83, 164, 0.18);
        border-radius: 16px;
        background: rgba(0, 83, 164, 0.06);
        padding: 1.25rem 1.5rem 0;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      }

      .collapsible-form summary {
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        list-style: none;
        font-size: 1.05rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(0, 83, 164, 0.18);
        color: var(--brand-secondary);
      }

      .collapsible-form summary::marker,
      .collapsible-form summary::-webkit-details-marker {
        display: none;
      }

      .collapsible-form summary::after {
        content: "";
        width: 12px;
        height: 12px;
        border-right: 2px solid currentColor;
        border-bottom: 2px solid currentColor;
        transform: rotate(45deg);
        transition: transform 0.2s ease;
        margin-left: 1rem;
      }

      .collapsible-form[open] summary::after {
        transform: rotate(225deg);
      }

      .collapsible-form[open] {
        background: rgba(0, 83, 164, 0.08);
        padding-bottom: 1.5rem;
      }

      .collapsible-form[open] summary {
        margin-bottom: 1rem;
        border-bottom-color: rgba(0, 83, 164, 0.25);
      }

      .minhas-grid {
        margin-top: 1rem;
      }

      .minha-card {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: 1px solid rgba(0, 83, 164, 0.18);
        border-radius: 14px;
        background: #ffffff;
        box-shadow: 0 10px 24px rgba(0, 45, 98, 0.12);
        position: relative;
        padding: 1.1rem 1.25rem;
      }

      .minha-card::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 14px;
        border: 2px solid transparent;
        transition: border-color 0.2s ease;
      }

      .minha-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 18px 34px rgba(0, 45, 98, 0.16);
      }

      .minha-card:hover::after {
        border-color: rgba(0, 163, 255, 0.5);
      }

      .minhas-placeholder {
        padding: 1.25rem;
        border-radius: 4px;
        background: rgba(0, 83, 164, 0.05);
        border: 1px dashed rgba(0, 83, 164, 0.2);
        color: var(--text-muted);
      }

      .feedback-modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(27, 38, 59, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        z-index: 1050;
      }
      .feedback-modal-backdrop.active { display: flex; }
      .feedback-modal {
        background: #ffffff;
        border-radius: 1.25rem;
        max-width: 980px;
        width: 100%;
        max-height: 88vh;
        box-shadow: 0 32px 68px rgba(0, 0, 0, 0.2);
        padding: 2rem;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
      }

      .feedback-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .modal-header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .modal-logo {
        max-height: 52px;
        width: auto;
        flex-shrink: 0;
      }

      .feedback-modal-title {
        font-weight: 700;
        font-size: 1.35rem;
        margin-bottom: 0.35rem;
        color: var(--text-strong);
      }

      .feedback-modal-subtitle {
        color: var(--text-muted);
        font-size: 0.95rem;
      }

      .modal-meta {
        background: rgba(0, 83, 164, 0.08);
        border-radius: 14px;
        padding: 0.75rem 1.2rem;
        min-width: 220px;
        text-align: right;
      }

      .modal-meta-label {
        display: block;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--brand-secondary);
        font-weight: 700;
      }

      .modal-meta-value {
        display: block;
        font-size: 1.05rem;
        font-weight: 700;
        color: var(--brand-primary);
        margin-top: 0.25rem;
      }

      .feedback-modal-message {
        font-size: 0.95rem;
        line-height: 1.6;
        color: var(--text-strong);
        overflow-y: auto;
        flex: 1;
      }

      .modal-table-wrapper {
        border-radius: 14px;
        border: 1px solid rgba(0, 83, 164, 0.12);
        background: #f8fbff;
        padding: 1rem;
      }

      .modal-table-wrapper table td:first-child {
        font-weight: 700;
        color: var(--brand-secondary);
      }

      .modal-actions {
        margin-top: 1.5rem;
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 0.75rem;
      }

      .modal-actions-default,
      .modal-actions-renovacoes {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 0.75rem;
        width: 100%;
      }

      .form-feedback {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.45);
        padding: 1.5rem;
        z-index: 1200;
      }

      .form-feedback.active {
        display: flex;
      }

      .form-feedback-dialog {
        position: relative;
        max-width: 420px;
        width: 100%;
        background: #ffffff;
        border-radius: 16px;
        padding: 1.75rem;
        box-shadow: 0 22px 50px rgba(15, 37, 78, 0.2);
        border: 1px solid rgba(0, 74, 173, 0.08);
      }

      .form-feedback-title {
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
      }

      .form-feedback-title.alert {
        color: #d92d20;
      }

      .form-feedback-title.success {
        color: #047857;
      }

      .form-feedback-body {
        color: var(--text-strong);
        font-size: 0.98rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .form-feedback-body ul {
        padding-left: 1.2rem;
        margin: 0;
      }

      .form-feedback-body li {
        margin-bottom: 0.35rem;
      }

      .form-feedback-close {
        position: absolute;
        top: 0.6rem;
        right: 0.6rem;
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-size: 1.2rem;
        cursor: pointer;
      }

      .form-feedback-close:focus {
        outline: 2px solid var(--brand-primary);
        outline-offset: 2px;
      }

      footer {
        color: var(--text-muted);
        padding: 2.5rem 0 2rem;
        font-size: 0.9rem;
      }

      .btn-primary {
        background-color: #0062ff;
        border-color: #0062ff;
        font-weight: 600;
        padding: 0.65rem 1.5rem;
      }

      .btn-primary:hover,
      .btn-primary:focus {
        background-color: #004bd6;
        border-color: #004bd6;
      }

      .btn-outline-primary {
        color: #0062ff;
        border-color: #0062ff;
        font-weight: 600;
        padding: 0.65rem 1.5rem;
      }

      .btn-outline-primary:hover,
      .btn-outline-primary:focus {
        background-color: rgba(0, 98, 255, 0.08);
        color: #004bd6;
        border-color: #004bd6;
      }

      .btn-soft {
        background-color: #f5f5f5;
        color: var(--text-strong);
        border: 1px solid #e5e7eb;
        font-weight: 600;
        padding: 0.65rem 1.5rem;
      }

      .btn-soft:hover,
      .btn-soft:focus {
        background-color: #e7e7e7;
        border-color: #d1d5db;
        color: var(--text-strong);
      }

      @media (max-width: 768px) {
        header.site-header { padding: 2.5rem 0 2rem; }
        .badge-open { width: 100%; justify-content: center; }
        .feedback-modal {
          padding: 1.5rem;
          max-height: 90vh;
        }
        .feedback-modal-header {
          flex-direction: column;
          align-items: stretch;
        }
        .modal-header-left {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.75rem;
        }
        .modal-logo {
          max-height: 42px;
        }
        .modal-meta {
          text-align: left;
        }
      }

      /* Impress√£o apenas do conte√∫do do modal */
      @media print {
        body * { visibility: hidden !important; }
        .feedback-modal, .feedback-modal * { visibility: visible !important; }
        .feedback-modal { position: absolute; inset: 0; box-shadow: none; }
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <div class="badge-open mb-3">
          <span class="text-white">Secretaria de Cultura ‚Ä¢ Escola de Frevo do Recife</span>
        </div>
        <div class="row">
          <div class="col-lg-8">
            <h1 class="h2 fw-bold mb-3 text-white">Escola de Frevo do Recife ‚Ä¢ Matr√≠cula</h1>
            <p class="lead">
              Preencha o formul√°rio abaixo para realizar sua inscri√ß√£o. Os campos marcados como obrigat√≥rios
              precisam ser completados para envio. Revise os dados e confira a pr√©-visualiza√ß√£o antes de confirmar.
            </p>
          </div>
        </div>
      </div>
    </header>

    <main class="py-5">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-xl-10">
            <div class="card card-programa">
              <div class="card-header">
                <div class="d-flex align-items-start justify-content-between flex-wrap gap-3">
                  <div class="flex-grow-1">
                    <div class="card-tag">Matr√≠cula</div>
                    <h2 class="card-title mb-1">Escola de Frevo do Recife</h2>
                    <p class="card-subtitle mb-0">
                      Insira seus dados pessoais, endere√ßo, informa√ß√µes de sa√∫de e anexe a documenta√ß√£o solicitada.
                    </p>
                  </div>
                  <div id="tipo-matricula-slot" class="d-flex align-items-start justify-content-end"></div>
                </div>
              </div>
              <div class="card-body">
                <form id="matricula-form" novalidate class="needs-validation">
                  <div id="form-sections" class="d-flex flex-column gap-4"></div>
                  <div class="d-flex flex-wrap gap-2 justify-content-end mt-4">
                    <button type="reset" class="btn btn-soft">Limpar</button>
                    <button type="submit" class="btn btn-primary">Enviar matr√≠cula</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div class="feedback-modal-backdrop" id="preview-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="feedback-modal">
        <div class="feedback-modal-header">
          <div class="modal-header-left">
            <img
              src="https://statics.recife.pe.gov.br/images/dynamics/conecta/icons/favicon.png?w=96&h=96&fit=fill"
              alt="Prefeitura do Recife"
              class="modal-logo"
            />
            <div>
              <div class="feedback-modal-title">Pr√©-visualiza√ß√£o do envio</div>
              <div class="feedback-modal-subtitle">
                Confira os dados preenchidos antes de confirmar a matr√≠cula.
              </div>
            </div>
          </div>
          <div class="modal-meta">
            <span class="modal-meta-label">Etapa</span>
            <span class="modal-meta-value">Revis√£o</span>
          </div>
        </div>
        <div class="feedback-modal-message">
          <div class="modal-table-wrapper">
            <table class="table table-sm mb-0 align-middle" id="preview-table">
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="modal-actions">
          <div class="modal-actions-default">
            <button type="button" class="btn btn-soft" id="close-preview">Voltar e editar</button>
            <button type="button" class="btn btn-primary" id="confirm-preview">Confirmar envio</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const formConfig = {
        "meta": {
          "formId": "userForm",
          "title": "Secretaria de Cultura ‚Ä¢ Escola de Frevo",
          "submitEndpoint": "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/efr",
          "notes": [
            "No submit, s√≥ s√£o inclu√≠dos campos que tenham atributo 'name'.",
            "Campos do tipo file s√£o enviados como '<name>_base64' e '<name>_ext'.",
            "Campos confirmadores (confirmarEmail/confirmarWhatsApp) n√£o possuem 'name' e n√£o s√£o enviados.",
            "O campo #proximonivel n√£o tem 'name' e n√£o √© enviado."
          ]
        },
        "sections": [
          {
            "id": "dados-pessoais",
            "label": "Dados Pessoais",
            "fields": [
              {
                "id": "tipoMatricula",
                "name": "tipomatricula",
                "label": "Tipo de matr√≠cula",
                "type": "hidden",
                "valueTemplate": "{{ $json.query.tipo_de_matricula }}",
                "required": false,
                "readOnly": false,
                "options": null,
                "validation": null,
                "dynamic": {
                  "controls": [
                    "Atualiza op√ß√µes do select #nivel via atualizarNiveis(tipoMatricula, proximonivel)"
                  ]
                },
                "sentOnSubmit": true
              },
              {
                "id": "proximonivel",
                "name": null,
                "label": "Pr√≥ximo n√≠vel",
                "type": "text",
                "visible": false,
                "valueTemplate": "{{ $json.query.nivel }}",
                "required": false,
                "readOnly": true,
                "options": null,
                "validation": null,
                "dynamic": {
                  "notes": [
                    "Est√° no DOM, mas n√£o √© enviado porque n√£o tem atributo name."
                  ]
                },
                "sentOnSubmit": false
              },
              {
                "id": "cpf",
                "name": "cpf_aluno",
                "label": "CPF",
                "type": "text",
                "placeholder": "000.000.000-00",
                "valueTemplate": "{{ $json.query.cpf }}",
                "required": false,
                "readOnly": "dynamic",
                "options": null,
                "validation": {
                  "client": [
                    "onblur buscarNome() chama webhook se cpf.length===11"
                  ],
                  "notes": [
                    "Se o valor vier com m√°scara (pontos/tra√ßo), cpf.length pode n√£o ser 11."
                  ]
                },
                "dynamic": {
                  "onLoad": [
                    "Se vier preenchido, seta readonly e chama buscarNome()"
                  ],
                  "webhookLookup": {
                    "endpoint": "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/buscar-pessoa",
                    "method": "POST",
                    "payload": {
                      "cpf": "<cpf (sem m√°scara, 11 d√≠gitos)>"
                    },
                    "fills": [
                      {
                        "targetId": "nomeCompleto",
                        "property": "value",
                        "fromResponsePath": "nome"
                      }
                    ]
                  }
                },
                "sentOnSubmit": true
              },
              {
                "id": "nomeCompleto",
                "name": "nome",
                "label": "Nome Completo",
                "type": "text",
                "placeholder": null,
                "valueTemplate": "{{ $json.query.nome }}",
                "required": true,
                "readOnly": "dynamic",
                "options": null,
                "validation": {
                  "pattern": "[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø\\s]+",
                  "inputSanitizer": "remove n√£o-letras/espa√ßo",
                  "transform": "upperCase"
                },
                "dynamic": {
                  "onLoad": [
                    "Se vier preenchido, seta readonly"
                  ]
                },
                "sentOnSubmit": true
              },
              {
                "id": "datanascimento",
                "name": "data_nasc",
                "label": "Data de Nascimento",
                "type": "date",
                "placeholder": null,
                "valueTemplate": null,
                "required": false,
                "readOnly": false,
                "options": null,
                "validation": null,
                "dynamic": {
                  "events": [
                    "blur -> calcularIdade()",
                    "blur -> buscarTurmas()"
                  ],
                  "ageRule": {
                    "minAgeYears": 6,
                    "behaviorIfUnderMin": [
                      "confirm dialog",
                      "OK: oculta container e mostra mensagem",
                      "Cancelar: limpa data/idade/faixa e mant√©m formul√°rio"
                    ]
                  }
                },
                "sentOnSubmit": true
              },
              {
                "id": "idade",
                "name": "idade",
                "label": "Idade",
                "type": "number",
                "placeholder": null,
                "valueTemplate": null,
                "required": false,
                "readOnly": true,
                "options": null,
                "validation": null,
                "dynamic": {
                  "filledBy": "calcularIdade()"
                },
                "sentOnSubmit": true
              },
              {
                "id": "faixaetaria",
                "name": "faixa_etaria",
                "label": "Faixa Et√°ria",
                "type": "text",
                "placeholder": null,
                "valueTemplate": null,
                "required": false,
                "readOnly": true,
                "options": null,
                "validation": null,
                "dynamic": {
                  "webhookLookup": {
                    "endpoint": "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/modalidade",
                    "method": "POST",
                    "payload": {
                      "idade": "<idade>"
                    },
                    "fills": [
                      {
                        "targetId": "faixaetaria",
                        "property": "value",
                        "fromResponsePath": "[0].faixa_etaria"
                      },
                      {
                        "targetId": "modalidade",
                        "property": "value",
                        "fromResponsePath": "[0].modalidade"
                      }
                    ]
                  }
                },
                "sentOnSubmit": true
              },
              {
                "id": "racacor",
                "name": "raca_cor",
                "label": "Ra√ßa/Cor",
                "type": "select",
                "required": false,
                "readOnly": false,
                "options": [
                  { "value": "selecione", "label": "Selecione" },
                  { "value": "amarela", "label": "Amarela" },
                  { "value": "branca", "label": "Branca" },
                  { "value": "indigena", "label": "Ind√≠gena" },
                  { "value": "parda", "label": "Parda" },
                  { "value": "preta", "label": "Preta" },
                  { "value": "naoinformar", "label": "Prefiro n√£o informar" }
                ],
                "validation": null,
                "dynamic": null,
                "sentOnSubmit": true
              },
              {
                "id": "genero",
                "name": "genero",
                "label": "G√™nero",
                "type": "select",
                "required": false,
                "readOnly": false,
                "options": [
                  { "value": "selecione", "label": "Selecione" },
                  { "value": "feminino", "label": "Feminino" },
                  { "value": "masculino", "label": "Masculino" },
                  { "value": "naoinformar", "label": "Prefiro n√£o informar" }
                ],
                "validation": null,
                "dynamic": null,
                "sentOnSubmit": true
              }
            ]
          },
          {
            "id": "endereco",
            "label": "Endere√ßo",
            "fields": [
              {
                "id": "cep",
                "name": "cep",
                "label": "CEP",
                "type": "text",
                "required": true,
                "readOnly": false,
                "placeholder": "00000-000",
                "validation": {
                  "maxLength": 8,
                  "transform": "digitsOnly"
                },
                "dynamic": {
                  "onChange": "buscarEndereco() via ViaCEP"
                },
                "sentOnSubmit": true
              },
              {
                "id": "logradouro",
                "name": "logradouro",
                "label": "Logradouro",
                "type": "text",
                "required": false,
                "readOnly": false,
                "placeholder": "Rua/Av/Estrada",
                "validation": {
                  "transform": "upperCase"
                },
                "dynamic": {
                  "filledBy": "ViaCEP"
                },
                "sentOnSubmit": true
              },
              {
                "id": "numero",
                "name": "numero",
                "label": "N√∫mero",
                "type": "text",
                "required": false,
                "readOnly": false,
                "placeholder": "N√∫mero",
                "validation": null,
                "dynamic": null,
                "sentOnSubmit": true
              },
              {
                "id": "complemento",
                "name": "complemento",
                "label": "Complemento",
                "type": "text",
                "required": false,
                "readOnly": false,
                "placeholder": "Apto, Bloco, etc.",
                "validation": {
                  "transform": "upperCase"
                },
                "dynamic": {
                  "filledBy": "ViaCEP (se houver)"
                },
                "sentOnSubmit": true
              },
              {
                "id": "bairro",
                "name": "bairro",
                "label": "Bairro",
                "type": "text",
                "required": false,
                "readOnly": false,
                "placeholder": "Bairro",
                "validation": {
                  "transform": "upperCase"
                },
                "dynamic": {
                  "filledBy": "ViaCEP"
                },
                "sentOnSubmit": true
              },
              {
                "id": "cidade",
                "name": "cidade",
                "label": "Cidade",
                "type": "text",
                "required": false,
                "readOnly": false,
                "placeholder": "Recife",
                "validation": {
                  "transform": "upperCase"
                },
                "dynamic": {
                  "filledBy": "ViaCEP"
                },
                "sentOnSubmit": true
              },
              {
                "id": "email",
                "name": "email",
                "label": "E-mail",
                "type": "email",
                "required": false,
                "readOnly": false,
                "placeholder": "seuemail@exemplo.com",
                "validation": {
                  "regex": "^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$",
                  "transform": "lowerCase"
                },
                "dynamic": {
                  "confirmFieldId": "confirmarEmail"
                },
                "sentOnSubmit": true
              },
              {
                "id": "confirmarEmail",
                "name": null,
                "label": "Confirme seu E-mail",
                "type": "email",
                "required": true,
                "readOnly": false,
                "placeholder": "Confirme seu e-mail",
                "validation": {
                  "mustMatchFieldId": "email"
                },
                "dynamic": null,
                "sentOnSubmit": false
              },
              {
                "id": "whatsapp",
                "name": "telefone",
                "label": "WhatsApp (11 d√≠gitos)",
                "type": "text",
                "required": false,
                "readOnly": false,
                "placeholder": "(81) 90000-0000",
                "validation": {
                  "transform": "digitsOnly",
                  "exactLength": 11
                },
                "dynamic": {
                  "confirmFieldId": "confirmarWhatsApp"
                },
                "sentOnSubmit": true
              },
              {
                "id": "confirmarWhatsApp",
                "name": null,
                "label": "Confirme seu WhatsApp",
                "type": "text",
                "required": true,
                "readOnly": false,
                "placeholder": "Confirme seu WhatsApp",
                "validation": {
                  "mustMatchFieldId": "whatsapp"
                },
                "dynamic": null,
                "sentOnSubmit": false
              }
            ]
          },
          {
            "id": "dados-saude",
            "label": "Sa√∫de",
            "fields": [
              {
                "id": "pcd_ask",
                "name": "pcd_ask",
                "label": "√â pessoa com defici√™ncia (PCD)?",
                "type": "select",
                "required": false,
                "options": [
                  { "value": "selecione", "label": "Selecione" },
                  { "value": "nao", "label": "N√£o" },
                  { "value": "sim", "label": "Sim" }
                ],
                "dynamic": {
                  "showsFieldIds": [
                    "tipo_def_ask",
                    "qual_deficiencia_ask"
                  ],
                  "responsibleLogicTrigger": true
                },
                "sentOnSubmit": true
              },
              {
                "id": "tipo_def_ask",
                "name": "tipo_pcd_ask",
                "label": "Qual o tipo de defici√™ncia?",
                "type": "select",
                "required": "conditional",
                "options": [
                  { "value": "selecione", "label": "Selecione" },
                  { "value": "auditiva", "label": "Auditiva" },
                  { "value": "fisica_motora", "label": "F√≠sica/motora" },
                  { "value": "intelectual", "label": "Intelectual" },
                  { "value": "visao", "label": "Visual" }
                ],
                "dynamic": {
                  "visibleWhen": {
                    "fieldId": "pcd_ask",
                    "equals": "sim"
                  },
                  "requiredWhen": {
                    "fieldId": "pcd_ask",
                    "equals": "sim"
                  },
                  "populates": {
                    "targetId": "qual_deficiencia_ask",
                    "optionsFrom": "deficiencias[tipo_def_ask]"
                  },
                  "responsibleLogicTrigger": true
                },
                "sentOnSubmit": true
              },
              {
                "id": "qual_deficiencia_ask",
                "name": "qual_deficiencia_ask",
                "label": "Qual a defici√™ncia?",
                "type": "select",
                "required": "conditional",
                "options": "dynamic",
                "dynamic": {
                  "visibleWhen": {
                    "fieldId": "tipo_def_ask",
                    "notEquals": "selecione"
                  },
                  "requiredWhen": {
                    "fieldId": "tipo_def_ask",
                    "notEquals": "selecione"
                  }
                },
                "sentOnSubmit": true
              },
              {
                "id": "contraindicacao_medica_ask",
                "name": "contraindicacao_medica_ask",
                "label": "Possui contraindica√ß√£o m√©dica/doen√ßa cr√¥nica?",
                "type": "select",
                "options": [
                  { "value": "selecione", "label": "Selecione" },
                  { "value": "nao", "label": "N√£o" },
                  { "value": "sim", "label": "Sim" }
                ],
                "sentOnSubmit": true
              },
              {
                "id": "qual_contraindicacao_ask",
                "name": "qual_contraindicacao_ask",
                "label": "Qual a contraindica√ß√£o/doen√ßa?",
                "type": "text",
                "required": "conditional",
                "validation": { "transform": "upperCase" },
                "dynamic": {
                  "visibleWhen": {
                    "fieldId": "contraindicacao_medica_ask",
                    "equals": "sim"
                  },
                  "requiredWhen": {
                    "fieldId": "contraindicacao_medica_ask",
                    "equals": "sim"
                  }
                },
                "sentOnSubmit": true
              },
              {
                "id": "realiza_atv_ask",
                "name": "realiza_atv_ask",
                "label": "Realiza alguma atividade f√≠sica?",
                "type": "select",
                "options": [
                  { "value": "selecione", "label": "Selecione" },
                  { "value": "nao", "label": "N√£o" },
                  { "value": "sim", "label": "Sim" }
                ],
                "sentOnSubmit": true
              },
              {
                "id": "descreva_atv_ask",
                "name": "descreva_atv_ask",
                "label": "Descreva a atividade",
                "type": "text",
                "required": "conditional",
                "validation": { "transform": "upperCase" },
                "dynamic": {
                  "visibleWhen": {
                    "fieldId": "realiza_atv_ask",
                    "equals": "sim"
                  },
                  "requiredWhen": {
                    "fieldId": "realiza_atv_ask",
                    "equals": "sim"
                  }
                },
                "sentOnSubmit": true
              },
              {
                "id": "usa_mediamento_ask",
                "name": "usa_medicamento_ask",
                "label": "Faz uso cont√≠nuo de algum medicamento?",
                "type": "select",
                "options": [
                  { "value": "selecione", "label": "Selecione" },
                  { "value": "nao", "label": "N√£o" },
                  { "value": "sim", "label": "Sim" }
                ],
                "sentOnSubmit": true
              },
              {
                "id": "descreva_medicamento_ask",
                "name": "descreva_medicamento_ask",
                "label": "Quais medicamentos?",
                "type": "text",
                "required": "conditional",
                "validation": { "transform": "upperCase" },
                "dynamic": {
                  "visibleWhen": {
                    "fieldId": "usa_mediamento_ask",
                    "equals": "sim"
                  },
                  "requiredWhen": {
                    "fieldId": "usa_mediamento_ask",
                    "equals": "sim"
                  }
                },
                "sentOnSubmit": true
              },
              {
                "id": "alergia_ask",
                "name": "alergia_ask",
                "label": "Possui alergia ou contraindica√ß√£o a medicamentos?",
                "type": "select",
                "options": [
                  { "value": "selecione", "label": "Selecione" },
                  { "value": "nao", "label": "N√£o" },
                  { "value": "sim", "label": "Sim" }
                ],
                "sentOnSubmit": true
              },
              {
                "id": "descreva_alergia_ask",
                "name": "descreva_alergia_ask",
                "label": "Qual alergia/contraindica√ß√£o?",
                "type": "text",
                "required": "conditional",
                "validation": { "transform": "upperCase" },
                "dynamic": {
                  "visibleWhen": {
                    "fieldId": "alergia_ask",
                    "equals": "sim"
                  },
                  "requiredWhen": {
                    "fieldId": "alergia_ask",
                    "equals": "sim"
                  }
                },
                "sentOnSubmit": true
              }
            ]
          },
          {
            "id": "dados-responsavel",
            "label": "Dados do Respons√°vel",
            "conditional": {
              "showWhenAny": [
                {
                  "type": "age",
                  "fieldId": "idade",
                  "operator": "<",
                  "value": 18
                },
                {
                  "type": "and",
                  "conditions": [
                    { "fieldId": "pcd_ask", "equals": "sim" },
                    { "fieldId": "tipo_def_ask", "equals": "intelectual" }
                  ]
                }
              ]
            },
            "fields": [
              {
                "id": "cpfresponsavel",
                "name": "cpf_responsavel",
                "label": "CPF do Respons√°vel",
                "type": "text",
                "placeholder": "000.000.000-00",
                "required": "conditional",
                "validation": {
                  "transform": "digitsOnly",
                  "maxLength": 11,
                  "exactLengthIfNotEmpty": 11
                },
                "dynamic": {
                  "webhookLookup": {
                    "endpoint": "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/buscar-pessoa",
                    "method": "POST",
                    "payload": {
                      "cpf": "<cpf_responsavel (11 d√≠gitos)>"
                    },
                    "fills": [
                      {
                        "targetId": "nomeCompletoResponsavel",
                        "property": "value",
                        "fromResponsePath": "nome"
                      }
                    ]
                  }
                },
                "sentOnSubmit": true
              },
              {
                "id": "nomeCompletoResponsavel",
                "name": "nome_responsavel",
                "label": "Nome do Respons√°vel",
                "type": "text",
                "placeholder": "Nome Completo",
                "required": "conditional",
                "validation": {
                  "transform": "upperCase"
                },
                "sentOnSubmit": true
              }
            ]
          },
          {
            "id": "dados-turma",
            "label": "Dados da Turma",
            "fields": [
              {
                "id": "modalidade",
                "name": "modalidade",
                "label": "Modalidade",
                "type": "text",
                "readOnly": true,
                "dynamic": {
                  "filledBy": "webhook/modalidade (com base na idade)"
                },
                "sentOnSubmit": true
              },
              {
                "id": "nivel",
                "name": "nivel",
                "label": "N√≠vel",
                "type": "select",
                "options": "dynamic",
                "dynamic": {
                  "rules": [
                    {
                      "when": { "fieldId": "tipomatricula", "equals": "Matr√≠cula nova" },
                      "options": [
                        { "value": "", "label": "Selecione o n√≠vel" },
                        { "value": "Livre", "label": "Livre" },
                        { "value": "Iniciante", "label": "Iniciante" }
                      ],
                      "disabled": false
                    },
                    {
                      "when": { "fieldId": "tipomatricula", "equals": "Renova√ß√£o" },
                      "options": [
                        {
                          "value": "<proximonivel>",
                          "label": "<proximonivel>"
                        }
                      ],
                      "disabled": true
                    }
                  ],
                  "events": [
                    "change/blur -> buscarTurmas()",
                    "change -> limparCamposTurma()"
                  ]
                },
                "sentOnSubmit": true
              },
              {
                "id": "turma",
                "name": "turma",
                "label": "Turma",
                "type": "select",
                "options": "dynamic",
                "dynamic": {
                  "filledByWebhook": {
                    "endpoint": "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/turmas-frevo-consulta",
                    "method": "POST",
                    "payload": {
                      "faixa_etaria": "<faixa_etaria>",
                      "nivel": "<texto vis√≠vel do option>",
                      "tipo_de_matricula": "<tipomatricula>"
                    },
                    "optionsLabelTemplate": "{turma} - {dias} ({horario}) - {local} - Prof. {professor}"
                  },
                  "onChange": "preencherDetalhesTurma()"
                },
                "sentOnSubmit": true
              },
              {
                "id": "dias",
                "name": "dias",
                "label": "Dias",
                "type": "text",
                "readOnly": true,
                "sentOnSubmit": true
              },
              {
                "id": "horario",
                "name": "horario",
                "label": "Hor√°rio",
                "type": "text",
                "readOnly": true,
                "sentOnSubmit": true
              },
              {
                "id": "local",
                "name": "sala",
                "label": "Sala",
                "type": "text",
                "readOnly": true,
                "sentOnSubmit": true
              },
              {
                "id": "professor",
                "name": "professor",
                "label": "Professor",
                "type": "text",
                "readOnly": true,
                "sentOnSubmit": true
              }
            ]
          },
          {
            "id": "documentacao",
            "label": "Documenta√ß√£o",
            "fields": [
              {
                "id": "possuirg",
                "name": "possuirg",
                "label": "Possui RG",
                "type": "select",
                "options": [
                  { "value": "", "label": "" },
                  { "value": "sim", "label": "Sim" },
                  { "value": "nao", "label": "N√£o" }
                ],
                "dynamic": {
                  "controlsVisibility": [
                    "Se sim: mostrar rg_frente + rg_verso e ocultar certidao_nasc",
                    "Se n√£o: ocultar rg_frente + rg_verso e mostrar certidao_nasc"
                  ],
                  "notes": [
                    "A fun√ß√£o toggleFields() existe, mas n√£o est√° claramente vinculada a onchange no select."
                  ]
                },
                "sentOnSubmit": true
              },
              {
                "id": "rg_frente",
                "name": "rg_frente",
                "label": "Anexar RG/CNH frente",
                "type": "file",
                "required": false,
                "sentOnSubmit": true,
                "submitTransforms": [
                  { "name": "rg_frente_base64", "type": "string(base64)" },
                  { "name": "rg_frente_ext", "type": "string" }
                ]
              },
              {
                "id": "rg_verso",
                "name": "rg_verso",
                "label": "Anexar RG/CNH verso",
                "type": "file",
                "required": false,
                "sentOnSubmit": true,
                "submitTransforms": [
                  { "name": "rg_verso_base64", "type": "string(base64)" },
                  { "name": "rg_verso_ext", "type": "string" }
                ]
              },
              {
                "id": "certidao_nasc",
                "name": "certidao_nasc",
                "label": "Anexar certid√£o de nascimento",
                "type": "file",
                "required": false,
                "sentOnSubmit": true,
                "submitTransforms": [
                  { "name": "certidao_nasc_base64", "type": "string(base64)" },
                  { "name": "certidao_nasc_ext", "type": "string" }
                ]
              },
              {
                "id": "parecer_medico",
                "name": "parecer_medico",
                "label": "Anexar laudo m√©dico",
                "type": "file",
                "required": false,
                "sentOnSubmit": true,
                "submitTransforms": [
                  { "name": "parecer_medico_base64", "type": "string(base64)" },
                  { "name": "parecer_medico_ext", "type": "string" }
                ]
              }
            ]
          }
        ],
        "computedOrDisplayOnly": [
          {
            "id": "tipoMatriculaDisplay",
            "type": "span",
            "label": "Tipo de matr√≠cula (display)",
            "sentOnSubmit": false
          },
          {
            "id": "submitButton",
            "type": "button",
            "label": "Enviar Matr√≠cula",
            "sentOnSubmit": false
          },
          {
            "id": "message",
            "type": "div",
            "label": "Mensagem (idade m√≠nima)",
            "sentOnSubmit": false
          }
        ],
        "submitPayload": {
          "baseFields": [
            "tipomatricula",
            "cpf_aluno",
            "nome",
            "data_nasc",
            "idade",
            "faixa_etaria",
            "raca_cor",
            "genero",
            "cep",
            "logradouro",
            "numero",
            "complemento",
            "bairro",
            "cidade",
            "email",
            "telefone",
            "pcd_ask",
            "tipo_pcd_ask",
            "qual_deficiencia_ask",
            "contraindicacao_medica_ask",
            "qual_contraindicacao_ask",
            "realiza_atv_ask",
            "descreva_atv_ask",
            "usa_medicamento_ask",
            "descreva_medicamento_ask",
            "alergia_ask",
            "descreva_alergia_ask",
            "cpf_responsavel",
            "nome_responsavel",
            "modalidade",
            "nivel",
            "turma",
            "dias",
            "horario",
            "sala",
            "professor",
            "possuirg"
          ],
          "filesAsBase64": [
            "rg_frente_base64",
            "rg_frente_ext",
            "rg_verso_base64",
            "rg_verso_ext",
            "certidao_nasc_base64",
            "certidao_nasc_ext",
            "parecer_medico_base64",
            "parecer_medico_ext"
          ]
        }
      };

      const formElement = document.getElementById("matricula-form");
      const sectionsContainer = document.getElementById("form-sections");
      const fieldRegistry = new Map();
      const statusSlot = document.getElementById("tipo-matricula-slot");
      let cepLoadingIndicator = null;
      let lastCepSearched = "";
      let nivelFetchController = null;
      let turmaFetchController = null;
      let turmaOptionsCache = [];

      const transforms = {
        digitsOnly: (value) => value.replace(/\\D+/g, ""),
        upperCase: (value) => value.toUpperCase(),
        lowerCase: (value) => value.toLowerCase()
      };

      const digitOnlyFields = new Set(["cpf", "cpfresponsavel", "cep", "whatsapp", "confirmarWhatsApp"]);

      function sanitizeDigitsInput(input) {
        const cursor = input.selectionStart;
        const clean = transforms.digitsOnly(input.value);
        if (input.value !== clean) {
          input.value = clean;
          if (cursor !== null) {
            const nextPos = Math.min(clean.length, Math.max(0, cursor - (input.value.length - clean.length)));
            input.setSelectionRange(nextPos, nextPos);
          }
        }
      }

      function sanitizeNumeroInput(input) {
        const raw = input.value.trim();
        if (!raw) {
          input.setCustomValidity("");
          return;
        }
        const upper = raw.toUpperCase();
        if (upper === "SN") {
          input.value = "SN";
          input.setCustomValidity("");
          return;
        }
        const digits = transforms.digitsOnly(raw);
        input.value = digits;
        if (!digits) {
          input.setCustomValidity('Use apenas d√≠gitos ou "SN".');
        } else {
          input.setCustomValidity("");
        }
      }

      function setLoadingCep(isLoading) {
        const cepEntry = fieldRegistry.get("cep");
        if (!cepEntry) return;
        const wrapper = cepEntry.wrapper;
        if (isLoading) {
          if (!cepLoadingIndicator) {
            cepLoadingIndicator = document.createElement("div");
            cepLoadingIndicator.className = "spinner-border spinner-border-sm text-primary ms-2";
            cepLoadingIndicator.setAttribute("role", "status");
            cepLoadingIndicator.setAttribute("aria-label", "Carregando CEP");
          }
          if (!wrapper.querySelector(".spinner-border")) {
            const group = wrapper.querySelector(".input-group");
            if (group) group.appendChild(cepLoadingIndicator);
          }
        } else if (cepLoadingIndicator?.parentElement) {
          cepLoadingIndicator.remove();
        }
      }

      function setCepMessage(message, type = "muted") {
        const feedback = document.getElementById("cep-feedback");
        if (!feedback) return;
        feedback.textContent = message;
        feedback.className = `form-text text-${type}`;
      }

      async function fetchCepBrasilApi(cep) {
        if (!cep || cep.length !== 8 || cep === lastCepSearched) return;
        lastCepSearched = cep;
        setLoadingCep(true);
        setCepMessage("Consultando CEP...", "primary");
        try {
          const response = await fetch(`https://brasilapi.com.br/api/cep/v1/${cep}`);
          if (!response.ok) throw new Error("CEP n√£o encontrado");
          const data = await response.json();
          const mapping = {
            logradouro: data.street,
            bairro: data.neighborhood,
            cidade: data.city,
            complemento: data.complement,
            cep: data.cep?.replace(/\D+/g, "")
          };
          Object.entries(mapping).forEach(([fieldId, value]) => {
            if (!value) return;
            const entry = fieldRegistry.get(fieldId);
            if (entry?.input && entry.wrapper.style.display !== "none") {
              entry.input.value = value;
            }
          });
          setCepMessage("Endere√ßo preenchido automaticamente. Confira os dados.", "success");
        } catch (error) {
          setCepMessage("CEP n√£o encontrado. Voc√™ pode preencher manualmente.", "danger");
        } finally {
          setLoadingCep(false);
        }
      }

      function clearEntry(entry) {
        if (!entry) return;
        const { input } = entry;
        if (!input) return;
        if (input.type === "checkbox" || input.type === "radio") {
          input.checked = false;
        } else {
          input.value = "";
        }
        input.required = false;
        input.setCustomValidity("");
        input.classList.remove("is-valid", "is-invalid");
      }

      function validateEmails() {
        const emailEntry = fieldRegistry.get("email");
        const confirmEntry = fieldRegistry.get("confirmarEmail");
        if (!emailEntry || !confirmEntry) return;
        const emailVal = emailEntry.input.value.trim().toLowerCase();
        const confirmVal = confirmEntry.input.value.trim().toLowerCase();
        if (emailVal && confirmVal && emailVal !== confirmVal) {
          emailEntry.input.setCustomValidity("Os e-mails devem ser iguais.");
          confirmEntry.input.setCustomValidity("Os e-mails devem ser iguais.");
        } else {
          emailEntry.input.setCustomValidity("");
          confirmEntry.input.setCustomValidity("");
        }
      }

      function validateWhatsapp() {
        const entry = fieldRegistry.get("whatsapp");
        if (!entry) return;
        const value = entry.input.value.trim();
        if (value && value.length !== 11) {
          entry.input.setCustomValidity("Informe exatamente 11 d√≠gitos (DDD + n√∫mero).");
        } else {
          entry.input.setCustomValidity("");
        }
      }

      function togglePcdFields() {
        const pcdEntry = fieldRegistry.get("pcd_ask");
        const tipoEntry = fieldRegistry.get("tipo_def_ask");
        const qualEntry = fieldRegistry.get("qual_deficiencia_ask");
        const isPcd = pcdEntry?.input?.value === "sim";
        if (tipoEntry) {
          tipoEntry.wrapper.style.display = isPcd ? "" : "none";
          tipoEntry.input.required = isPcd;
          if (!isPcd) clearEntry(tipoEntry);
        }
        if (qualEntry) {
          const showQual = isPcd && tipoEntry?.input?.value && tipoEntry.input.value !== "selecione";
          qualEntry.wrapper.style.display = showQual ? "" : "none";
          qualEntry.input.required = showQual;
          if (!showQual) clearEntry(qualEntry);
        }
      }

      function toggleResponsavelSection() {
        const section = document.querySelector('[data-section-id="dados-responsavel"]');
        const age = parseInt(fieldRegistry.get("idade")?.input?.value || "0", 10);
        const tipoDef = fieldRegistry.get("tipo_def_ask")?.input?.value || "";
        const ageValid = Number.isFinite(age) && age > 0;
        const shouldShow = (ageValid && age < 18) || tipoDef === "intelectual";
        if (!section) return;
        section.style.display = shouldShow ? "" : "none";
        if (!shouldShow) {
          ["cpfresponsavel", "nomeCompletoResponsavel"].forEach((id) => clearEntry(fieldRegistry.get(id)));
        } else {
          ["cpfresponsavel", "nomeCompletoResponsavel"].forEach((id) => {
            const entry = fieldRegistry.get(id);
            if (entry?.config?.required === "conditional") entry.input.required = true;
          });
        }
      }

      function setTipoMatriculaValue(value) {
        const statusEntry = fieldRegistry.get("tipoMatricula");
        if (!statusEntry) return;
        statusEntry.input.value = value || "";
        const display = document.getElementById("tipoMatricula-display");
        if (display) display.textContent = value || "‚Äî";
        fetchNivelOptions(fieldRegistry.get("nivel")?.input?.value || "");
      }

      function applyPrefillFromJson() {
        const fallbackPattern = /^\s*\{\{\s*\$json\.[^}]+\}\}\s*$/;
        const sanitizeTemplateValue = (value) => {
          if (value === undefined || value === null) return "";
          const str = String(value).trim();
          if (!str || fallbackPattern.test(str)) return "";
          return str;
        };
        const dispatchPrefillEvents = (element) => {
          ["input", "change"].forEach((type) => element.dispatchEvent(new Event(type, { bubbles: true })));
        };

        const source =
          typeof $json !== "undefined"
            ? Array.isArray($json)
              ? $json[0]
              : $json
            : typeof window.prefillData !== "undefined"
            ? window.prefillData
            : null;
        if (!source) return;
        fieldRegistry.forEach((entry) => {
          const key = entry.config.name || entry.config.id;
          if (!key || !(key in source)) return;
          const value = sanitizeTemplateValue(source[key]);
          if (value === undefined || value === null) return;
          if (entry.input instanceof HTMLInputElement || entry.input instanceof HTMLSelectElement || entry.input instanceof HTMLTextAreaElement) {
            entry.input.value = value;
            if (entry.input.dataset.digitsOnly === "true") sanitizeDigitsInput(entry.input);
            if (entry.input.dataset.numero === "true") sanitizeNumeroInput(entry.input);
            dispatchPrefillEvents(entry.input);
          }
        });
        computeAge();
        togglePcdFields();
        toggleResponsavelSection();
      }

      function createOptionElements(options, targetSelect) {
        targetSelect.innerHTML = "";
        options.forEach((opt) => {
          const optionEl = document.createElement("option");
          optionEl.value = opt.value ?? "";
          optionEl.textContent = opt.label ?? "";
          targetSelect.appendChild(optionEl);
        });
      }

      function applyValidationAttributes(input, validation) {
        if (!validation) return;
        if (validation.pattern) input.setAttribute("pattern", validation.pattern);
        if (validation.regex) input.setAttribute("pattern", validation.regex);
        if (validation.maxLength) input.setAttribute("maxlength", validation.maxLength);
        if (validation.exactLength) input.dataset.exactLength = validation.exactLength;
        if (validation.exactLengthIfNotEmpty) input.dataset.exactLengthIfNotEmpty = validation.exactLengthIfNotEmpty;
        if (validation.mustMatchFieldId) input.dataset.mustMatch = validation.mustMatchFieldId;
        if (validation.transform && transforms[validation.transform] && !digitOnlyFields.has(input.id)) {
          input.dataset.transform = validation.transform;
        }
        if (digitOnlyFields.has(input.id)) {
          input.setAttribute("pattern", "\\d*");
          input.inputMode = "numeric";
        }
      }

      function buildField(field) {
        if (field.id === "tipoMatricula") {
          const hidden = document.createElement("input");
          hidden.type = "hidden";
          hidden.id = field.id;
          if (field.name) hidden.name = field.name;
          formElement.appendChild(hidden);

          const statusWrapper = document.createElement("div");
          statusWrapper.className = "modal-meta";
          const label = document.createElement("span");
          label.className = "modal-meta-label";
          label.textContent = "Tipo de matr√≠cula";
          const display = document.createElement("span");
          display.className = "modal-meta-value";
          display.id = `${field.id}-display`;
          display.textContent = "‚Äî";
          statusWrapper.append(label, display);
          if (statusSlot) statusSlot.appendChild(statusWrapper);
          fieldRegistry.set(field.id, { config: field, input: hidden, wrapper: statusWrapper });
          return null;
        }

        const formGroup = document.createElement("div");
        formGroup.className = "col-12";
        formGroup.dataset.fieldId = field.id;

        const isHidden = field.type === "hidden" || field.visible === false;
        if (isHidden) {
          formGroup.style.display = "none";
        }

        if (field.type !== "hidden") {
          const label = document.createElement("label");
          label.className = "form-label fw-semibold";
          label.setAttribute("for", field.id);
          label.textContent = field.label || "";
          formGroup.appendChild(label);
        }

        let input;
        if (field.type === "select") {
          input = document.createElement("select");
          input.className = "form-select";
          if (Array.isArray(field.options)) {
            createOptionElements(field.options, input);
          }
        } else if (field.type === "textarea") {
          input = document.createElement("textarea");
          input.className = "form-control";
          input.rows = 3;
          input.placeholder = field.placeholder || "";
        } else if (field.type === "radio" || field.type === "checkbox") {
          input = document.createElement("div");
          input.className = "d-flex flex-wrap gap-2";
          if (Array.isArray(field.options)) {
            field.options.forEach((opt, index) => {
              const wrapper = document.createElement("div");
              wrapper.className = "form-check";
              const control = document.createElement("input");
              control.type = field.type;
              control.className = "form-check-input";
              control.id = `${field.id}-${index}`;
              control.name = field.name || field.id;
              control.value = opt.value ?? "";
              const optLabel = document.createElement("label");
              optLabel.className = "form-check-label";
              optLabel.setAttribute("for", control.id);
              optLabel.textContent = opt.label ?? "";
              wrapper.append(control, optLabel);
              input.appendChild(wrapper);
            });
          }
        } else {
          input = document.createElement("input");
          input.type = field.type || "text";
          input.className = "form-control";
          input.placeholder = field.placeholder || "";
        }

        if (field.type !== "radio" && field.type !== "checkbox") {
          input.id = field.id;
          if (field.name) input.name = field.name;
          if (field.readOnly === true) input.readOnly = true;
          if (field.readOnly === "dynamic") input.dataset.readonlyDynamic = "true";
          if (field.valueTemplate) input.value = "";
          if (field.required === true) input.required = true;
          applyValidationAttributes(input, field.validation);
          if (field.type === "file" && field.accept) input.accept = field.accept;
          if (digitOnlyFields.has(field.id)) input.dataset.digitsOnly = "true";
          if (field.id === "numero") input.dataset.numero = "true";
        }

        if (field.type !== "hidden") {
          const feedback = document.createElement("div");
          feedback.className = "invalid-feedback";
          feedback.textContent = "Este campo √© obrigat√≥rio ou possui formato inv√°lido.";
          let appendElement = input;
          if (field.id === "cep") {
            const group = document.createElement("div");
            group.className = "input-group";
            group.appendChild(input);
            appendElement = group;
          }
          if (field.type === "file") {
            const help = document.createElement("div");
            help.className = "form-text";
            help.textContent = "Anexe o arquivo solicitado.";
            formGroup.appendChild(help);
          }
          formGroup.append(appendElement, feedback);
          if (field.id === "cep") {
            const helper = document.createElement("div");
            helper.id = "cep-feedback";
            helper.className = "form-text text-muted";
            helper.textContent = "Digite 8 d√≠gitos para buscar o endere√ßo automaticamente.";
            formGroup.appendChild(helper);
          }
        } else {
          formGroup.appendChild(input);
        }

        if (field.type === "radio" || field.type === "checkbox") {
          formGroup.appendChild(input);
        }

        fieldRegistry.set(field.id, { config: field, input, wrapper: formGroup });
        return formGroup;
      }

      function evaluateFieldVisibility(fieldId) {
        const entry = fieldRegistry.get(fieldId);
        if (!entry) return;
        const { config, wrapper } = entry;
        const dynamic = config.dynamic;
        if (dynamic && dynamic.visibleWhen) {
          const controller = fieldRegistry.get(dynamic.visibleWhen.fieldId);
          const controllerValue = controller?.input?.value || "";
          let isVisible = true;
          if (dynamic.visibleWhen.equals !== undefined) {
            isVisible = controllerValue === dynamic.visibleWhen.equals;
          }
          if (dynamic.visibleWhen.notEquals !== undefined) {
            isVisible = controllerValue !== dynamic.visibleWhen.notEquals;
          }
          wrapper.style.display = isVisible ? "" : "none";
          if (!isVisible) {
            const controlInput = entry.input;
            if (controlInput) {
              controlInput.value = "";
              controlInput.removeAttribute("required");
            }
          }
        }
      }

      function evaluateFieldRequired(fieldId) {
        const entry = fieldRegistry.get(fieldId);
        if (!entry) return;
        const { config, input } = entry;
        const dynamic = config.dynamic;
        if (config.required === true) {
          input.required = true;
          return;
        }
        if (dynamic && dynamic.requiredWhen) {
          const controller = fieldRegistry.get(dynamic.requiredWhen.fieldId);
          const controllerValue = controller?.input?.value || "";
          let mustRequire = false;
          if (dynamic.requiredWhen.equals !== undefined) {
            mustRequire = controllerValue === dynamic.requiredWhen.equals;
          }
          if (dynamic.requiredWhen.notEquals !== undefined) {
            mustRequire = controllerValue !== dynamic.requiredWhen.notEquals;
          }
          input.required = mustRequire;
          if (!mustRequire) {
            input.setCustomValidity("");
          }
        } else if (config.required === "conditional") {
          input.required = false;
        }
      }

      function evaluateSection(sectionConfig) {
        const sectionElement = document.querySelector(`[data-section-id="${sectionConfig.id}"]`);
        if (!sectionConfig.conditional || !sectionElement) return;
        const { showWhenAny } = sectionConfig.conditional;
        let shouldShow = false;
        showWhenAny.forEach((rule) => {
          if (rule.type === "age") {
            const ageEntry = fieldRegistry.get(rule.fieldId);
            const ageValue = parseInt(ageEntry?.input?.value || "0", 10);
            if (Number.isFinite(ageValue)) {
              if (rule.operator === "<" && ageValue < rule.value) shouldShow = true;
              if (rule.operator === ">" && ageValue > rule.value) shouldShow = true;
              if (rule.operator === "<=" && ageValue <= rule.value) shouldShow = true;
              if (rule.operator === ">=" && ageValue >= rule.value) shouldShow = true;
            }
          }
          if (rule.type === "and" && Array.isArray(rule.conditions)) {
            const matches = rule.conditions.every((cond) => {
              const entry = fieldRegistry.get(cond.fieldId);
              const value = entry?.input?.value || "";
              if (cond.equals !== undefined) return value === cond.equals;
              if (cond.notEquals !== undefined) return value !== cond.notEquals;
              return false;
            });
            if (matches) shouldShow = true;
          }
        });
        sectionElement.style.display = shouldShow ? "" : "none";
        sectionElement.querySelectorAll("input, select, textarea").forEach((el) => {
          const fieldId = el.id || el.name;
          const entry = fieldRegistry.get(fieldId);
          if (!shouldShow) {
            el.value = "";
            el.required = false;
          } else if (entry?.config?.required === "conditional") {
            el.required = true;
          }
        });
      }

      function handleConditionalFields() {
        fieldRegistry.forEach((entry, id) => {
          evaluateFieldVisibility(id);
          evaluateFieldRequired(id);
        });
        formConfig.sections.forEach((section) => evaluateSection(section));
        togglePcdFields();
        toggleResponsavelSection();
      }

      function buildSection(section) {
        const sectionContainer = document.createElement("section");
        sectionContainer.className = "border rounded-4 p-3 p-md-4 bg-light";
        sectionContainer.dataset.sectionId = section.id;

        const title = document.createElement("div");
        title.className = "section-title mb-3";
        title.textContent = section.label;
        sectionContainer.appendChild(title);

        const row = document.createElement("div");
        row.className = "row g-3";
        section.fields.forEach((field) => {
          const fieldEl = buildField(field);
          if (fieldEl) row.appendChild(fieldEl);
        });
        sectionContainer.appendChild(row);
        sectionsContainer.appendChild(sectionContainer);
      }

      function enforceTransforms(event) {
        const input = event.target;
        const transformKey = input.dataset.transform;
        if (transformKey && transforms[transformKey]) {
          const cursorPos = input.selectionStart;
          input.value = transforms[transformKey](input.value);
          if (cursorPos !== null) {
            input.setSelectionRange(cursorPos, cursorPos);
          }
        }
      }

      function enforceExactLength(input) {
        const exact = input.dataset.exactLength || input.dataset.exactLengthIfNotEmpty;
        if (!exact) return true;
        if (input.dataset.exactLengthIfNotEmpty && input.value.length === 0) {
          input.setCustomValidity("");
          return true;
        }
        if (input.value.length !== Number(exact)) {
          input.setCustomValidity(`Informe exatamente ${exact} d√≠gitos.`);
          return false;
        }
        input.setCustomValidity("");
        return true;
      }

      function enforceMatch(input) {
        const targetId = input.dataset.mustMatch;
        if (!targetId) return;
        const targetEntry = fieldRegistry.get(targetId);
        const targetValue = (targetEntry?.input?.value || "").trim();
        const inputValue = (input.value || "").trim();
        if (targetId === "email" || input.id === "confirmarEmail") {
          const normalizedInput = inputValue.trim().toLowerCase();
          const normalizedTarget = targetValue.trim().toLowerCase();
          if (normalizedInput && normalizedTarget && normalizedInput !== normalizedTarget) {
            input.setCustomValidity("Os valores precisam ser iguais.");
          } else {
            input.setCustomValidity("");
          }
        } else {
          if (inputValue && inputValue !== targetValue) {
            input.setCustomValidity("Os valores precisam ser iguais.");
          } else {
            input.setCustomValidity("");
          }
        }
      }

      function computeAnoLetivo() {
        const now = new Date();
        const month = now.getMonth();
        return month >= 11 ? now.getFullYear() + 1 : now.getFullYear();
      }

      function normalizeNivelOptions(data) {
        const options = [];
        const pushOption = (value, label) => {
          const val = value ?? "";
          const lab = label ?? value ?? "";
          if (String(val).trim() === "" && String(lab).trim() === "") return;
          options.push({ value: String(val), label: String(lab || val) });
        };

        const processArray = (arr) => {
          arr.forEach((item) => {
            if (typeof item === "string" || typeof item === "number") {
              pushOption(item, item);
            } else if (item && typeof item === "object") {
              const value = item.value ?? item.nivel ?? item.nome ?? item.name ?? item.label ?? "";
              const label = item.label ?? item.nivel ?? item.nome ?? item.name ?? item.value ?? value;
              pushOption(value, label);
            }
          });
        };

        if (Array.isArray(data)) {
          processArray(data);
        } else if (data && typeof data === "object") {
          if (Array.isArray(data.options)) processArray(data.options);
          else if (Array.isArray(data.niveis)) processArray(data.niveis);
          else if (Array.isArray(data.data)) processArray(data.data);
        }
        return options;
      }

      function setNivelOptions(options, requestedValue) {
        const nivelEntry = fieldRegistry.get("nivel");
        if (!nivelEntry) return;
        const select = nivelEntry.input;
        const targetValue = requestedValue ?? select.value ?? "";
        const opts = options && options.length ? options : [{ value: "", label: "Selecione" }];
        select.innerHTML = "";
        let hasTarget = false;
        opts.forEach((opt) => {
          const optionEl = document.createElement("option");
          optionEl.value = opt.value ?? "";
          optionEl.textContent = opt.label ?? opt.value ?? "";
          if (optionEl.value === targetValue) hasTarget = true;
          select.appendChild(optionEl);
        });
        if (targetValue && !hasTarget) {
          const fallbackOption = document.createElement("option");
          fallbackOption.value = targetValue;
          fallbackOption.textContent = targetValue;
          select.appendChild(fallbackOption);
          select.value = targetValue;
        } else {
          select.value = targetValue;
        }
        if (!select.value && select.options.length) {
          select.selectedIndex = 0;
        }
      }

      async function fetchNivelOptions(requestedValue) {
        const nivelEntry = fieldRegistry.get("nivel");
        if (!nivelEntry) return;
        const select = nivelEntry.input;
        const tipo = (fieldRegistry.get("tipoMatricula")?.input?.value || "").trim();
        const faixa = (fieldRegistry.get("faixaetaria")?.input?.value || "").trim();
        const modalidade = (fieldRegistry.get("modalidade")?.input?.value || "").trim();
        const anoLetivo = computeAnoLetivo();

        if (!tipo && !faixa && !modalidade) {
          setNivelOptions([], requestedValue);
          fetchTurmaOptions();
          return;
        }

        if (nivelFetchController) {
          nivelFetchController.abort();
        }
        nivelFetchController = new AbortController();
        select.disabled = true;
        setNivelOptions([{ value: "", label: "Carregando..." }], requestedValue);

        try {
          const response = await fetch("https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/nivel", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ano_letivo: anoLetivo,
              tipomatricula: tipo,
              faixa_etaria: faixa,
              modalidade
            }),
            signal: nivelFetchController.signal
          });
          const data = await response.json().catch(() => []);
          const normalized = normalizeNivelOptions(data);
          setNivelOptions(normalized, requestedValue);
          fetchTurmaOptions();
        } catch (error) {
          if (error.name !== "AbortError") {
            setNivelOptions([], requestedValue);
            fetchTurmaOptions();
          }
        } finally {
          select.disabled = false;
          nivelFetchController = null;
        }
      }

      function normalizeTurmaOptions(data) {
        const options = [];
        const pushOption = (item) => {
          if (!item || typeof item !== "object") return;
          const value = item.turma ?? item.nome_turma ?? item.value ?? item.nome ?? item.name ?? "";
          const label = item.label ?? item.nome_turma ?? item.turma ?? item.nome ?? item.value ?? value;
          if (!String(value).trim() && !String(label).trim()) return;
          options.push({
            value: String(value),
            label: String(label),
            dias: item.dias ?? "",
            horario: item.horario ?? item.hora ?? "",
            sala: item.sala ?? item.local ?? item.espaco ?? "",
            professor: item.professor ?? item.prof ?? item.instrutor ?? ""
          });
        };

        const processArray = (arr) => arr.forEach((item) => {
          if (typeof item === "string" || typeof item === "number") {
            pushOption({ turma: item, label: item });
          } else {
            pushOption(item);
          }
        });

        if (Array.isArray(data)) {
          processArray(data);
        } else if (data && typeof data === "object") {
          if (Array.isArray(data.options)) processArray(data.options);
          else if (Array.isArray(data.turmas)) processArray(data.turmas);
          else if (Array.isArray(data.data)) processArray(data.data);
        }
        return options;
      }

      function setTurmaOptions(options, requestedValue) {
        const turmaEntry = fieldRegistry.get("turma");
        if (!turmaEntry) return;
        const select = turmaEntry.input;
        const targetValue = requestedValue ?? select.value ?? "";
        const opts = options && options.length ? options : [{ value: "", label: "Selecione" }];
        select.innerHTML = "";
        turmaOptionsCache = opts;
        let hasTarget = false;
        opts.forEach((opt) => {
          const optionEl = document.createElement("option");
          optionEl.value = opt.value ?? "";
          optionEl.textContent = opt.label ?? opt.value ?? "";
          if (optionEl.value === targetValue) hasTarget = true;
          select.appendChild(optionEl);
        });
        if (targetValue && !hasTarget) {
          const fallbackOption = document.createElement("option");
          fallbackOption.value = targetValue;
          fallbackOption.textContent = targetValue;
          select.appendChild(fallbackOption);
          select.value = targetValue;
        } else {
          select.value = targetValue;
        }
        if (!select.value && select.options.length) {
          select.selectedIndex = 0;
        }
        applyTurmaDetails(select.value);
      }

      function clearTurmaDetails() {
        ["dias", "horario", "sala", "professor"].forEach((id) => {
          const entry = fieldRegistry.get(id === "sala" ? "local" : id);
          if (entry?.input) entry.input.value = "";
        });
      }

      function applyTurmaDetails(selectedValue) {
        const match = turmaOptionsCache.find((opt) => opt.value === selectedValue);
        if (!match) {
          clearTurmaDetails();
          return;
        }
        const diasEntry = fieldRegistry.get("dias");
        const horarioEntry = fieldRegistry.get("horario");
        const salaEntry = fieldRegistry.get("local");
        const professorEntry = fieldRegistry.get("professor");
        if (diasEntry?.input) diasEntry.input.value = match.dias || "";
        if (horarioEntry?.input) horarioEntry.input.value = match.horario || "";
        if (salaEntry?.input) salaEntry.input.value = match.sala || "";
        if (professorEntry?.input) professorEntry.input.value = match.professor || "";
      }

      async function fetchTurmaOptions(requestedValue) {
        const turmaEntry = fieldRegistry.get("turma");
        if (!turmaEntry) return;
        const select = turmaEntry.input;
        const faixa = (fieldRegistry.get("faixaetaria")?.input?.value || "").trim();
        const modalidade = (fieldRegistry.get("modalidade")?.input?.value || "").trim();
        const nivel = (fieldRegistry.get("nivel")?.input?.value || "").trim();
        const tipo = (fieldRegistry.get("tipoMatricula")?.input?.value || "").trim();
        const anoLetivo = computeAnoLetivo();

        if (!faixa || !modalidade || !nivel) {
          setTurmaOptions([], requestedValue);
          clearTurmaDetails();
          return;
        }

        if (turmaFetchController) turmaFetchController.abort();
        turmaFetchController = new AbortController();
        select.disabled = true;
        setTurmaOptions([{ value: "", label: "Carregando..." }], requestedValue);
        clearTurmaDetails();

        try {
          const response = await fetch("https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/turmas-frevo", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ faixa_etaria: faixa, modalidade, nivel, tipomatricula: tipo, ano_letivo: anoLetivo }),
            signal: turmaFetchController.signal
          });
          const data = await response.json().catch(() => []);
          const normalized = normalizeTurmaOptions(data);
          setTurmaOptions(normalized, requestedValue);
        } catch (error) {
          if (error.name !== "AbortError") {
            setTurmaOptions([], requestedValue);
            clearTurmaDetails();
          }
        } finally {
          select.disabled = false;
          turmaFetchController = null;
        }
      }

      function toggleDocumentFields() {
        const possessEntry = fieldRegistry.get("possuirg");
        if (!possessEntry) return;
        const value = possessEntry.input.value;
        const showRG = value === "sim";
        const showCertidao = value === "nao";
        ["rg_frente", "rg_verso"].forEach((id) => {
          const entry = fieldRegistry.get(id);
          if (entry) {
            entry.wrapper.style.display = showRG ? "" : "none";
            if (!showRG) clearEntry(entry);
          }
        });
        const certidaoEntry = fieldRegistry.get("certidao_nasc");
        if (certidaoEntry) {
          certidaoEntry.wrapper.style.display = showCertidao ? "" : "none";
          if (!showCertidao) clearEntry(certidaoEntry);
        }
      }

      function computeAge() {
        const birthEntry = fieldRegistry.get("datanascimento");
        const ageEntry = fieldRegistry.get("idade");
        if (!birthEntry || !ageEntry) return;
        const birthDate = birthEntry.input.value ? new Date(birthEntry.input.value) : null;
        if (!birthDate || Number.isNaN(birthDate.getTime())) {
          ageEntry.input.value = "";
          return;
        }
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
          age--;
        }
        ageEntry.input.value = age;
      }

      function collectPreviewData() {
        const rows = [];
        fieldRegistry.forEach((entry) => {
          const { config, input, wrapper } = entry;
          if (!config.name || wrapper.style.display === "none") return;
          let value = "";
          if (config.type === "file") {
            value = input.files.length ? Array.from(input.files).map((f) => f.name).join(", ") : "";
          } else if (config.type === "select" || config.type === "text" || config.type === "date" || config.type === "number" || config.type === "email") {
            value = input.value || "";
          } else if (config.type === "radio" || config.type === "checkbox") {
            const selected = wrapper.querySelectorAll("input:checked");
            value = Array.from(selected).map((el) => el.value).join(", ");
          }
          rows.push({ label: config.label || config.id, value });
        });
        return rows;
      }

      function populatePreviewTable() {
        const tbody = document.querySelector("#preview-table tbody");
        tbody.innerHTML = "";
        collectPreviewData().forEach((row) => {
          const tr = document.createElement("tr");
          const th = document.createElement("td");
          th.textContent = row.label;
          const td = document.createElement("td");
          td.textContent = row.value || "‚Äî";
          tr.append(th, td);
          tbody.appendChild(tr);
        });
      }

      function showPreview() {
        populatePreviewTable();
        const backdrop = document.getElementById("preview-backdrop");
        backdrop.classList.add("active");
        backdrop.setAttribute("aria-hidden", "false");
      }

      function hidePreview() {
        const backdrop = document.getElementById("preview-backdrop");
        backdrop.classList.remove("active");
        backdrop.setAttribute("aria-hidden", "true");
      }

      function attachEvents() {
        formElement.addEventListener("input", (event) => {
          if (!(event.target instanceof HTMLInputElement || event.target instanceof HTMLTextAreaElement || event.target instanceof HTMLSelectElement)) return;
          if (event.target.dataset.digitsOnly === "true") sanitizeDigitsInput(event.target);
          if (event.target.dataset.numero === "true") sanitizeNumeroInput(event.target);
          enforceTransforms(event);
          enforceExactLength(event.target);
          enforceMatch(event.target);
          if (event.target.id === "email") {
            const confirmEmail = fieldRegistry.get("confirmarEmail")?.input;
            if (confirmEmail) enforceMatch(confirmEmail);
          }
          if (event.target.id === "whatsapp") {
            const confirmWhatsapp = fieldRegistry.get("confirmarWhatsApp")?.input;
            if (confirmWhatsapp) enforceMatch(confirmWhatsapp);
          }
          if (event.target.id === "faixaetaria" || event.target.id === "modalidade") {
            fetchNivelOptions(fieldRegistry.get("nivel")?.input?.value || "");
          }
          if (event.target.id === "nivel") {
            fetchTurmaOptions(fieldRegistry.get("turma")?.input?.value || "");
          }
          if (event.target.dataset.readonlyDynamic === "true" && event.target.value === "") {
            event.target.readOnly = false;
          } else if (event.target.dataset.readonlyDynamic === "true" && event.target.value) {
            event.target.readOnly = true;
          }
          if (event.target.id === "whatsapp") validateWhatsapp();
          if (event.target.id === "email" || event.target.id === "confirmarEmail") validateEmails();
          if (event.target.id === "cep") {
            const cepValue = event.target.value.trim();
            if (cepValue.length === 8) {
              fetchCepBrasilApi(cepValue);
            } else {
              lastCepSearched = "";
              setLoadingCep(false);
              setCepMessage("Digite 8 d√≠gitos para buscar o endere√ßo automaticamente.", "muted");
            }
          }
          handleConditionalFields();
        });

        formElement.addEventListener("change", (event) => {
          if (!(event.target instanceof HTMLInputElement || event.target instanceof HTMLSelectElement)) return;
          if (event.target.id === "tipoMatricula") setTipoMatriculaValue(event.target.value);
          if (event.target.id === "tipoMatricula" || event.target.id === "faixaetaria" || event.target.id === "modalidade") {
            fetchNivelOptions(fieldRegistry.get("nivel")?.input?.value || "");
          }
          if (event.target.id === "nivel") {
            fetchTurmaOptions(fieldRegistry.get("turma")?.input?.value || "");
          }
          if (event.target.id === "turma") {
            applyTurmaDetails(event.target.value);
          }
          if (event.target.id === "possuirg") toggleDocumentFields();
          if (event.target.id === "pcd_ask" || event.target.id === "tipo_def_ask") togglePcdFields();
          if (event.target.id === "tipo_def_ask") toggleResponsavelSection();
          handleConditionalFields();
        });

        const birthInput = fieldRegistry.get("datanascimento")?.input;
        if (birthInput) {
          birthInput.addEventListener("blur", () => {
            computeAge();
            handleConditionalFields();
          });
        }

        formElement.addEventListener("submit", (event) => {
          event.preventDefault();
          validateEmails();
          validateWhatsapp();
          const numeroEntry = fieldRegistry.get("numero");
          if (numeroEntry) sanitizeNumeroInput(numeroEntry.input);
          const formValid = formElement.checkValidity();
          formElement.classList.add("was-validated");
          if (!formValid) return;
          showPreview();
        });

        formElement.addEventListener("reset", () => {
          setTimeout(() => {
            formElement.classList.remove("was-validated");
            fieldRegistry.forEach((entry) => {
              if (entry.input.type !== "hidden") entry.input.setCustomValidity("");
            });
            fetchNivelOptions();
            toggleDocumentFields();
            togglePcdFields();
            toggleResponsavelSection();
            lastCepSearched = "";
            setLoadingCep(false);
            setCepMessage("Digite 8 d√≠gitos para buscar o endere√ßo automaticamente.", "muted");
            handleConditionalFields();
          }, 0);
        });

        document.getElementById("close-preview").addEventListener("click", hidePreview);
        document.getElementById("confirm-preview").addEventListener("click", () => {
          hidePreview();
          const toast = document.createElement("div");
          toast.className = "form-feedback active";
          toast.innerHTML = `
            <div class="form-feedback-dialog">
              <button class="form-feedback-close" aria-label="Fechar">√ó</button>
              <div class="form-feedback-title success">Envio simulado</div>
              <div class="form-feedback-body">
                <p>O envio real foi impedido para seguran√ßa. Revise a pr√©-visualiza√ß√£o antes de reenviar.</p>
              </div>
            </div>`;
          document.body.appendChild(toast);
          toast.querySelector(".form-feedback-close").addEventListener("click", () => toast.remove());
          setTimeout(() => toast.remove(), 6000);
        });
      }

      function init() {
        formConfig.sections.forEach(buildSection);
        formElement.id = formConfig.meta.formId || formElement.id;
        applyPrefillFromJson();
        setTipoMatriculaValue(fieldRegistry.get("tipoMatricula")?.input?.value || "");
        toggleDocumentFields();
        togglePcdFields();
        toggleResponsavelSection();
        handleConditionalFields();
        attachEvents();
      }

      init();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const prefill = {
          tipomatricula: "{{ $json.tipomatricula }}",
          cpf_aluno: "{{ $json.cpf_aluno }}",
          nome: "{{ $json.nome }}",
          data_nasc: "{{ $json.data_nasc }}",
          idade: "{{ $json.idade }}",
          faixa_etaria: "{{ $json.faixa_etaria }}",
          raca_cor: "{{ $json.raca_cor }}",
          genero: "{{ $json.genero }}",
          cep: "{{ $json.cep }}",
          logradouro: "{{ $json.logradouro }}",
          numero: "{{ $json.numero }}",
          complemento: "{{ $json.complemento }}",
          bairro: "{{ $json.bairro }}",
          cidade: "{{ $json.cidade }}",
          email: "{{ $json.email }}",
          telefone: "{{ $json.telefone }}",
          pcd_ask: "{{ $json.pcd_ask }}",
          tipo_pcd_ask: "{{ $json.tipo_pcd_ask }}",
          qual_deficiencia_ask: "{{ $json.qual_deficiencia_ask }}",
          cpf_responsavel: "{{ $json.cpf_responsavel }}",
          nome_responsavel: "{{ $json.nome_responsavel }}",
          modalidade: "{{ $json.modalidade }}",
          nivel: "{{ $json.nivel }}",
          turma: "{{ $json.turma }}",
          dias: "{{ $json.dias }}",
          horario: "{{ $json.horario }}",
          sala: "{{ $json.sala }}",
          professor: "{{ $json.professor }}"
        };

        const fallbackPattern = /^\s*\{\{\s*\$json\.[^}]+\}\}\s*$/;
        const sanitizeTemplateValue = (value) => {
          if (value === undefined || value === null) return "";
          const str = String(value).trim();
          if (!str || fallbackPattern.test(str)) return "";
          return str;
        };

        const normalizeDigitsOnly = (value) => sanitizeTemplateValue(value).replace(/\D+/g, "");
        const normalizeNumero = (value) => {
          const sanitized = sanitizeTemplateValue(value);
          if (!sanitized) return "";
          if (sanitized.trim().toUpperCase() === "SN") return "SN";
          return sanitized.replace(/\D+/g, "");
        };
        const normalizeEmail = (value) => sanitizeTemplateValue(value);
        const normalizeByKey = (key, value) => {
          switch (key) {
            case "cpf_aluno":
            case "cpf_responsavel":
            case "cep":
            case "telefone":
              return normalizeDigitsOnly(value);
            case "numero":
              return normalizeNumero(value);
            case "email":
              return normalizeEmail(value);
            default:
              return sanitizeTemplateValue(value);
          }
        };

        const resolvedPrefill = Object.fromEntries(
          Object.entries(prefill).map(([key, value]) => [key, normalizeByKey(key, value)])
        );

        const dispatchUpdateEvents = (element) => {
          ["input", "change"].forEach((type) => element.dispatchEvent(new Event(type, { bubbles: true })));
        };

        const truthyValues = ["sim", "true", "1", "on", "yes", "y"];
        const falsyValues = ["nao", "n√£o", "false", "0", "off", "no", "n"];

        const setSelectValue = (select, value) => {
          const target = (value || "").toString().toLowerCase();
          let matched = null;
          Array.from(select.options).forEach((opt) => {
            const optValue = (opt.value || "").toLowerCase();
            const optText = (opt.textContent || "").toLowerCase();
            if (optValue === target || optText === target) matched = opt;
          });
          if (matched) {
            select.value = matched.value;
          } else {
            select.value = value ?? "";
          }
          dispatchUpdateEvents(select);
        };

        const setTextValue = (element, value) => {
          element.value = value ?? "";
          dispatchUpdateEvents(element);
        };

        const setRadioValue = (elements, value) => {
          const target = (value || "").toString().toLowerCase();
          if (!target) return;
          elements.forEach((radio) => {
            const radioValue = (radio.value || "").toLowerCase();
            const shouldCheck = radioValue === target;
            radio.checked = shouldCheck;
            if (shouldCheck) dispatchUpdateEvents(radio);
          });
        };

        const setCheckboxValue = (elements, value) => {
          const normalized = (value || "").toString().toLowerCase();
          const list = normalized
            .split(/[,;]/)
            .map((part) => part.trim())
            .filter(Boolean);
          if (!normalized) return;

          elements.forEach((checkbox) => {
            let shouldCheck = false;
            const checkboxValue = (checkbox.value || "").toLowerCase();
            if (elements.length === 1) {
              shouldCheck = truthyValues.includes(normalized)
                ? true
                : falsyValues.includes(normalized)
                ? false
                : checkbox.checked;
            } else if (list.length > 0) {
              shouldCheck = list.includes(checkboxValue);
            }
            checkbox.checked = shouldCheck;
            dispatchUpdateEvents(checkbox);
          });
        };

        const fillField = (key, value) => {
          const targets = new Set();
          const byId = document.getElementById(key);
          if (byId) targets.add(byId);
          document.querySelectorAll(`[name="${key}"]`).forEach((el) => targets.add(el));
          if (!targets.size) return;

          const elements = Array.from(targets);
          const radios = elements.filter((el) => el instanceof HTMLInputElement && el.type === "radio");
          if (radios.length) {
            setRadioValue(radios, value);
            return;
          }

          const checkboxes = elements.filter((el) => el instanceof HTMLInputElement && el.type === "checkbox");
          if (checkboxes.length) {
            setCheckboxValue(checkboxes, value);
            return;
          }

          const select = elements.find((el) => el instanceof HTMLSelectElement);
          if (select) {
            setSelectValue(select, value);
            return;
          }

          const textInput = elements.find(
            (el) =>
              el instanceof HTMLInputElement ||
              el instanceof HTMLTextAreaElement ||
              el instanceof HTMLSelectElement
          );
          if (textInput) {
            setTextValue(textInput, value);
          }
        };

        Object.entries(resolvedPrefill).forEach(([key, value]) => {
          fillField(key, value);
        });
      });
    </script>
  </body>
</html>
