<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Secretaria de Cultura ‚Ä¢ Escola de Frevo</title>
    <link rel="icon"
        href="https://statics.recife.pe.gov.br/images/dynamics/conecta/icons/favicon.png?w=32&h=32&fit=fill&border=2,transparent,shrink" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --brand-primary: #004aad;
            --brand-secondary: #003579;
            --brand-highlight: #00a3ff;
            --surface: #ffffff;
            --surface-strong: #ffffff;
            --border-color: #d6deea;
            --text-strong: #1f2937;
            --text-muted: #4b5563;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", "Roboto", "Open Sans", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--surface);
            color: var(--text-strong);
            min-height: 100vh;
        }

        header.site-header {
            background: url("https://statics.recife.pe.gov.br/images/dynamics/automacao/header.png?w=3000") center/cover no-repeat;
            color: #ffffff;
            padding: 6rem 0 5rem;
            /* Increased padding */
            min-height: 250px;
        }

        header .lead {
            color: rgba(255, 255, 255, 0.9);
            max-width: 100%;
            font-size: 1rem;
            line-height: 1.65;
            text-align: justify;
        }

        .badge-open {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            font-weight: 600;
            padding: 0.45rem 0.9rem;
            border-radius: 999px;
            background-color: rgba(255, 255, 255, 0.14);
        }

        .user-greeting {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.05rem;
            font-weight: 500;
            margin-bottom: 2.5rem;
            padding: 1.2rem 1.6rem;
            border-radius: 18px;
            background: var(--surface-strong);
            color: var(--text-strong);
            border: 1px solid rgba(0, 83, 164, 0.12);
            box-shadow: 0 16px 34px rgba(0, 45, 98, 0.08);
        }

        .user-greeting::before {
            content: "üëã";
            font-size: 1.4rem;
        }

        .user-greeting strong {
            color: var(--brand-secondary);
        }

        .card {
            border-radius: 16px;
            overflow: hidden;
            border: none;
        }

        .rounded-4 {
            border-radius: 16px !important;
        }

        .card-programa {
            border: 1px solid rgba(0, 74, 173, 0.08);
            border-radius: 16px;
            background: var(--surface-strong);
            box-shadow: 0 12px 32px rgba(15, 37, 78, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            height: 100%;
        }

        .card-programa:hover {
            transform: translateY(-4px);
            box-shadow: 0 18px 40px rgba(15, 37, 78, 0.12);
        }

        .card-programa .card-header {
            border-bottom: 1px solid rgba(0, 74, 173, 0.1);
            background: linear-gradient(180deg, #ffffff 0%, #f6f9ff 100%);
            padding: 1.5rem 1.5rem 1.2rem;
        }

        .card-programa .card-body {
            padding: 1.5rem;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: 0.02em;
            color: var(--brand-primary);
        }

        .section-title::before {
            content: "";
            display: inline-block;
            width: 28px;
            height: 3px;
            border-radius: 999px;
            background: var(--brand-highlight);
        }

        .card-hero .card-body {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .card-hero .card-tag {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            color: #004aad;
            text-transform: uppercase;
        }

        .card-hero .card-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: #004aad;
            margin: 0;
        }

        .card-hero .card-subtitle {
            font-size: 1rem;
            color: var(--text-muted);
            margin: 0;
        }

        .card-hero .card-list {
            padding-left: 1.1rem;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            color: var(--text-strong);
        }

        .card-hero .card-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .downloads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.25rem;
        }

        .download-card {
            border: 1px solid var(--border-color);
            background: var(--surface-strong);
            border-radius: 4px;
            padding: 1.35rem 1.4rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-height: 170px;
        }

        .mapa-unidades-wrapper {
            border-radius: 12px;
            overflow: hidden;
            background: #f6f9ff;
        }

        .mapa-unidades-frame {
            border: 0;
            width: 100%;
            height: 100%;
        }

        .collapsible-form {
            border: 1px solid rgba(0, 83, 164, 0.18);
            border-radius: 16px;
            background: rgba(0, 83, 164, 0.06);
            padding: 1.25rem 1.5rem 0;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .collapsible-form summary {
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            list-style: none;
            font-size: 1.05rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(0, 83, 164, 0.18);
            color: var(--brand-secondary);
        }

        .collapsible-form summary::marker,
        .collapsible-form summary::-webkit-details-marker {
            display: none;
        }

        .collapsible-form summary::after {
            content: "";
            width: 12px;
            height: 12px;
            border-right: 2px solid currentColor;
            border-bottom: 2px solid currentColor;
            transform: rotate(45deg);
            transition: transform 0.2s ease;
            margin-left: 1rem;
        }

        .collapsible-form[open] summary::after {
            transform: rotate(225deg);
        }

        .collapsible-form[open] {
            background: rgba(0, 83, 164, 0.08);
            padding-bottom: 1.5rem;
        }

        .collapsible-form[open] summary {
            margin-bottom: 1rem;
            border-bottom-color: rgba(0, 83, 164, 0.25);
        }

        .minhas-grid {
            margin-top: 1rem;
        }

        .minha-card {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid rgba(0, 83, 164, 0.18);
            border-radius: 14px;
            background: #ffffff;
            box-shadow: 0 10px 24px rgba(0, 45, 98, 0.12);
            position: relative;
            padding: 1.1rem 1.25rem;
        }

        .minha-card::after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 14px;
            border: 2px solid transparent;
            transition: border-color 0.2s ease;
        }

        .minha-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 18px 34px rgba(0, 45, 98, 0.16);
        }

        .minha-card:hover::after {
            border-color: rgba(0, 163, 255, 0.5);
        }

        .minhas-placeholder {
            padding: 1.25rem;
            border-radius: 4px;
            background: rgba(0, 83, 164, 0.05);
            border: 1px dashed rgba(0, 83, 164, 0.2);
            color: var(--text-muted);
        }

        .feedback-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(27, 38, 59, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            z-index: 1050;
        }

        .feedback-modal-backdrop.active {
            display: flex;
        }

        .feedback-modal {
            background: #ffffff;
            border-radius: 1.25rem;
            max-width: 980px;
            width: 100%;
            max-height: 88vh;
            box-shadow: 0 32px 68px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }

        .feedback-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .modal-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .modal-logo {
            max-height: 52px;
            width: auto;
            flex-shrink: 0;
        }

        .feedback-modal-title {
            font-weight: 700;
            font-size: 1.35rem;
            margin-bottom: 0.35rem;
            color: var(--text-strong);
        }

        .feedback-modal-subtitle {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .modal-meta {
            background: rgba(0, 83, 164, 0.08);
            border-radius: 14px;
            padding: 0.75rem 1.2rem;
            min-width: 220px;
            text-align: right;
        }

        .modal-meta-label {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--brand-secondary);
            font-weight: 700;
        }

        .modal-meta-value {
            display: block;
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--brand-primary);
            margin-top: 0.25rem;
        }

        .feedback-modal-message {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-strong);
            overflow-y: auto;
            flex: 1;
        }

        .modal-table-wrapper {
            border-radius: 14px;
            border: 1px solid rgba(0, 83, 164, 0.12);
            background: #f8fbff;
            padding: 1rem;
        }

        .modal-table-wrapper table td:first-child {
            font-weight: 700;
            color: var(--brand-secondary);
        }

        .modal-actions {
            margin-top: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .modal-actions-default,
        .modal-actions-renovacoes {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end;
            gap: 0.75rem;
            width: 100%;
        }

        .form-feedback {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.45);
            padding: 1.5rem;
            z-index: 1200;
        }

        .form-feedback.active {
            display: flex;
        }

        .form-feedback-dialog {
            position: relative;
            max-width: 420px;
            width: 100%;
            background: #ffffff;
            border-radius: 16px;
            padding: 1.75rem;
            box-shadow: 0 22px 50px rgba(15, 37, 78, 0.2);
            border: 1px solid rgba(0, 74, 173, 0.08);
        }

        .form-feedback-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .form-feedback-title.alert {
            color: #d92d20;
        }

        .form-feedback-title.success {
            color: #047857;
        }

        .form-feedback-body {
            color: var(--text-strong);
            font-size: 0.98rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .form-feedback-body ul {
            padding-left: 1.2rem;
            margin: 0;
        }

        .form-feedback-body li {
            margin-bottom: 0.35rem;
        }

        .form-feedback-close {
            position: absolute;
            top: 0.6rem;
            right: 0.6rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .form-feedback-close:focus {
            outline: 2px solid var(--brand-primary);
            outline-offset: 2px;
        }

        footer {
            color: var(--text-muted);
            padding: 2.5rem 0 2rem;
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: #0062ff;
            border-color: #0062ff;
            font-weight: 600;
            padding: 0.65rem 1.5rem;
        }

        .btn-primary:hover,
        .btn-primary:focus {
            background-color: #004bd6;
            border-color: #004bd6;
        }

        .btn-outline-primary {
            color: #0062ff;
            border-color: #0062ff;
            font-weight: 600;
            padding: 0.65rem 1.5rem;
        }

        .btn-outline-primary:hover,
        .btn-outline-primary:focus {
            background-color: rgba(0, 98, 255, 0.08);
            color: #004bd6;
            border-color: #004bd6;
        }

        .btn-soft {
            background-color: #f5f5f5;
            color: var(--text-strong);
            border: 1px solid #e5e7eb;
            font-weight: 600;
            padding: 0.65rem 1.5rem;
        }

        .btn-soft:hover,
        .btn-soft:focus {
            background-color: #e7e7e7;
            border-color: #d1d5db;
            color: var(--text-strong);
        }

        @media (max-width: 768px) {
            header.site-header {
                padding: 2.5rem 0 2rem;
            }

            .badge-open {
                width: 100%;
                justify-content: center;
            }

            .feedback-modal {
                padding: 1.5rem;
                max-height: 90vh;
            }

            .feedback-modal-header {
                flex-direction: column;
                align-items: stretch;
            }

            .modal-header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .modal-logo {
                max-height: 42px;
            }

            .modal-meta {
                text-align: left;
            }
        }

        /* Impress√£o apenas do conte√∫do do modal */
        @media print {
            body * {
                visibility: hidden !important;
            }

            .feedback-modal,
            .feedback-modal * {
                visibility: visible !important;
            }

            .feedback-modal {
                position: absolute;
                inset: 0;
                box-shadow: none;
            }
        }

        /* New Modern Stepper Progress Bar */
        .stepper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            position: relative;
            padding: 0 1rem;
        }

        .stepper::before {
            content: "";
            position: absolute;
            top: 20px;
            left: 50px;
            right: 50px;
            height: 2px;
            background: #e5e7eb;
            z-index: 1;
        }

        .step-item {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            flex: 1;
        }

        .step-icon {
            width: 48px;
            height: 48px;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            filter: grayscale(100%) opacity(0.5);
            transition: all 0.3s ease;
            margin-bottom: 0.5rem;
        }

        .step-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }

        .step-item.active .step-icon,
        .step-item.completed .step-icon {
            filter: none;
            opacity: 1;
            transform: scale(1.25);
        }

        .step-item.active .step-label {
            color: var(--brand-primary);
        }

        .step-item.completed .step-label {
            color: var(--brand-highlight);
        }

        /* Responsive Stepper */
        @media (max-width: 768px) {
            .step-label {
                display: none;
            }

            .stepper::before {
                left: 20px;
                right: 20px;
            }
        }
    </style>
</head>


<body>
    <header class="site-header">
        <div class="container text-center h-100 d-flex align-items-center justify-content-center">
            <h1 class="display-4 fw-bold text-white mb-0" style="text-shadow: 2px 2px 8px rgba(0,0,0,0.6);">
                Escola de Frevo do Recife
            </h1>
        </div>
    </header>

    <div class="container py-5">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <form id="userForm">
                    <div class="stepper mb-5">
                        <div class="step-item active" onclick="updateProgress('dados-pessoais')">
                            <div class="step-icon">üë§</div>
                            <div class="step-label">Dados Pessoais</div>
                        </div>
                        <div class="step-item" onclick="updateProgress('endereco')">
                            <div class="step-icon">üìç</div>
                            <div class="step-label">Endere√ßo</div>
                        </div>
                        <div class="step-item" onclick="updateProgress('dados-saude')">
                            <div class="step-icon">ü©∫</div>
                            <div class="step-label">Sa√∫de</div>
                        </div>
                        <div class="step-item" onclick="updateProgress('dados-turma')">
                            <div class="step-icon">üé∂</div>
                            <div class="step-label">Turma</div>
                        </div>
                        <div class="step-item" onclick="updateProgress('documentacao')">
                            <div class="step-icon">üìÑ</div>
                            <div class="step-label">Documentos</div>
                        </div>
                    </div>

                    <div class="mt-4">

                        <div class="d-flex justify-content-end mb-4">
                            <div class="d-flex align-items-center p-3 bg-light rounded shadow-sm border border-secondary-subtle"
                                style="width: fit-content;">
                                <span class="text-uppercase fw-bold text-muted me-2 small">Tipo de matr√≠cula:</span>
                                <span class="badge bg-primary fs-6 py-2 px-3 rounded-pill shadow-sm">
                                    <i class="fas fa-id-card me-2"></i>
                                    <span id="tipoMatriculaDisplay">{{ $json.query.tipo_de_matricula }}</span>
                                </span>
                            </div>
                        </div>
                        <input type="hidden" id="tipoMatricula" name="tipomatricula"
                            value="{{ $json.query.tipo_de_matricula }}">
                        <label for="proximonivel" style="display: none;">Pr√≥ximo N√≠vel</label>
                        <input type="text" id="proximonivel" placeholder="Pr√≥ximo N√≠vel" value="{{ $json.query.nivel }}"
                            style="display: none;" readonly>

                        <div class="section" id="dados-pessoais" onfocusin="updateProgress('dados-pessoais')">
                            <h3 class="mb-4 text-primary"><i class="fas fa-user me-2"></i> Dados Pessoais</h3>

                            <div class="row g-3">
                                <!-- Row 1: CPF & Nome -->
                                <div class="col-md-3">
                                    <label for="cpf" class="form-label">CPF</label>
                                    <input type="text" id="cpf" name="cpf_aluno" class="form-control"
                                        placeholder="000.000.000-00" value="{{ $json.query.cpf }}"
                                        onblur="buscarNome()">
                                </div>
                                <div class="col-md-9">
                                    <label for="nomeCompleto" class="form-label">Nome Completo</label>
                                    <input type="text" id="nomeCompleto" name="nome" class="form-control" required
                                        pattern="[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø\s]+"
                                        oninput="this.value = this.value.replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø\s]/g, '')"
                                        value="{{ $json.query.nome }}">
                                </div>

                                <!-- Row 2: Nascimento, Idade, Faixa Et√°ria, Ra√ßa -->
                                <div class="col-md-3">
                                    <label for="datanascimento" class="form-label">Data de Nascimento</label>
                                    <input type="date" id="datanascimento" name="data_nasc" class="form-control"
                                        onchange="calcularIdade(); buscarFaixaetaria()">
                                </div>
                                <div class="col-md-2">
                                    <label for="idade" class="form-label">Idade</label>
                                    <input type="number" id="idade" name="idade" class="form-control bg-light" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label for="faixaetaria" class="form-label">Faixa Et√°ria</label>
                                    <input type="text" id="faixaetaria" name="faixa_etaria"
                                        class="form-control bg-light" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label for="racacor" class="form-label">Ra√ßa/Cor</label>
                                    <select id="racacor" name="raca_cor" class="form-select">
                                        <option value="selecione">Selecione</option>
                                        <option value="amarela">Amarela</option>
                                        <option value="branca">Branca</option>
                                        <option value="indigena">Ind√≠gena</option>
                                        <option value="parda">Parda</option>
                                        <option value="preta">Preta</option>
                                        <option value="naoinformar">Prefiro n√£o informar</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="genero" class="form-label">G√™nero</label>
                                    <select id="genero" name="genero" class="form-select">
                                        <option value="selecione">Selecione</option>
                                        <option value="feminino">Feminino</option>
                                        <option value="masculino">Masculino</option>
                                        <option value="naoinformar">Prefiro n√£o informar</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="section" id="endereco" onfocusin="updateProgress('endereco')">
                            <h3 class="mb-4 text-primary"><i class="fas fa-map-marker-alt me-2"></i> Endere√ßo</h3>

                            <div class="row g-3">
                                <!-- Row 1: CEP, Logradouro, N√∫mero -->
                                <div class="col-md-3">
                                    <label for="cep" class="form-label">CEP</label>
                                    <input type="text" id="cep" name="cep" class="form-control" required maxlength="8"
                                        placeholder="00000-000" oninput="this.value = this.value.replace(/\D/g, '')"
                                        onchange="buscarEndereco()">
                                </div>
                                <div class="col-md-6">
                                    <label for="logradouro" class="form-label">Logradouro</label>
                                    <input type="text" id="logradouro" name="logradouro" class="form-control"
                                        placeholder="Rua/Av/Estrada">
                                </div>
                                <div class="col-md-3">
                                    <label for="numero" class="form-label">N√∫mero</label>
                                    <input type="text" id="numero" name="numero" class="form-control"
                                        placeholder="N√∫mero">
                                </div>

                                <!-- Row 2: Complemento, Bairro, Cidade -->
                                <div class="col-md-4">
                                    <label for="complemento" class="form-label">Complemento</label>
                                    <input type="text" id="complemento" name="complemento" class="form-control"
                                        placeholder="Apto, Bloco, etc.">
                                </div>
                                <div class="col-md-4">
                                    <label for="bairro" class="form-label">Bairro</label>
                                    <input type="text" id="bairro" name="bairro" class="form-control"
                                        placeholder="Bairro">
                                </div>
                                <div class="col-md-4">
                                    <label for="cidade" class="form-label">Cidade</label>
                                    <input type="text" id="cidade" name="cidade" class="form-control"
                                        placeholder="Recife">
                                </div>

                                <!-- Row 3: Email & Confirmar Email -->
                                <div class="col-md-6">
                                    <label for="email" class="form-label">E-mail</label>
                                    <input type="email" id="email" name="email" class="form-control"
                                        placeholder="seuemail@exemplo.com">
                                </div>
                                <div class="col-md-6">
                                    <label for="confirmarEmail" class="form-label">Confirme seu E-mail</label>
                                    <input type="email" id="confirmarEmail" class="form-control"
                                        placeholder="Confirme seu e-mail">
                                </div>

                                <!-- Row 4: WhatsApp & Confirmar WhatsApp -->
                                <div class="col-md-6">
                                    <label for="whatsapp" class="form-label">WhatsApp (11 d√≠gitos)</label>
                                    <input type="text" id="whatsapp" name="telefone" class="form-control"
                                        placeholder="(81) 90000-0000">
                                </div>
                                <div class="col-md-6">
                                    <label for="confirmarWhatsApp" class="form-label">Confirme seu WhatsApp</label>
                                    <input type="text" id="confirmarWhatsApp" class="form-control"
                                        placeholder="Confirme seu WhatsApp">
                                </div>
                            </div>
                        </div>

                        <div class="section" id="dados-saude" onfocusin="updateProgress('dados-saude')">
                            <h3 class="mb-4 text-primary"><i class="fas fa-heartbeat me-2"></i> Dados de Sa√∫de</h3>

                            <div class="row g-3">
                                <!-- PCD Group -->
                                <div class="col-md-4">
                                    <label for="pcd_ask" class="form-label">√â pessoa com defici√™ncia (PCD)?</label>
                                    <select id="pcd_ask" name="pcd_ask" class="form-select">
                                        <option value="selecione">Selecione</option>
                                        <option value="nao">N√£o</option>
                                        <option value="sim">Sim</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="tipo_def_ask" class="form-label">Qual o tipo de defici√™ncia?</label>
                                    <select id="tipo_def_ask" name="tipo_pcd_ask" class="form-select">
                                        <option value="selecione">Selecione</option>
                                        <option value="auditiva">Auditiva</option>
                                        <option value="fisica_motora">F√≠sica/motora</option>
                                        <option value="intelectual">Intelectual</option>
                                        <option value="visao">Visual</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="qual_deficiencia_ask" class="form-label">Qual a defici√™ncia?</label>
                                    <select id="qual_deficiencia_ask" name="qual_deficiencia_ask" class="form-select">
                                        <!-- Populated dynamically via JS possibly, keeping structure -->
                                    </select>
                                </div>

                                <hr class="my-3 text-muted">

                                <!-- Contraindica√ß√£o Group -->
                                <div class="col-md-6">
                                    <label for="contraindicacao_medica_ask" class="form-label">Possui contraindica√ß√£o
                                        m√©dica/doen√ßa cr√¥nica?</label>
                                    <select id="contraindicacao_medica_ask" name="contraindicacao_medica_ask"
                                        class="form-select">
                                        <option value="selecione">Selecione</option>
                                        <option value="nao">N√£o</option>
                                        <option value="sim">Sim</option>
                                    </select>
                                </div>
                                <div class="col-md-6" id="div-qual-contra" style="display: none;">
                                    <!-- Wrapper may be needed for layout, JS controls display of input directly usually, but good to check scripts. Assuming direct display:none on input for now as per original. -->
                                    <label for="qual_contraindicacao_ask" class="form-label" style="display: none;">Qual
                                        a contraindica√ß√£o/doen√ßa?</label>
                                    <input type="text" id="qual_contraindicacao_ask" name="qual_contraindicacao_ask"
                                        class="form-control" placeholder="Informe a contraindica√ß√£o"
                                        style="display: none;">
                                </div>

                                <!-- Atividade F√≠sica Group -->
                                <div class="col-md-6">
                                    <label for="realiza_atv_ask" class="form-label">Realiza alguma atividade
                                        f√≠sica?</label>
                                    <select id="realiza_atv_ask" name="realiza_atv_ask" class="form-select">
                                        <option value="selecione">Selecione</option>
                                        <option value="nao">N√£o</option>
                                        <option value="sim">Sim</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="descreva_atv_ask" class="form-label" style="display: none;">Descreva a
                                        atividade</label>
                                    <input type="text" id="descreva_atv_ask" name="descreva_atv_ask"
                                        class="form-control" placeholder="Descreva a atividade" style="display: none;">
                                </div>

                                <hr class="my-3 text-muted">

                                <!-- Medicamento Group -->
                                <div class="col-md-6">
                                    <label for="usa_mediamento_ask" class="form-label">Faz uso cont√≠nuo de algum
                                        medicamento?</label>
                                    <select id="usa_mediamento_ask" name="usa_medicamento_ask" class="form-select">
                                        <option value="selecione">Selecione</option>
                                        <option value="nao">N√£o</option>
                                        <option value="sim">Sim</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="descreva_medicamento_ask" class="form-label"
                                        style="display: none;">Quais medicamentos?</label>
                                    <input type="text" id="descreva_medicamento_ask" name="descreva_medicamento_ask"
                                        class="form-control" placeholder="Descreva medicamentos" style="display: none;">
                                </div>

                                <!-- Alergia Group -->
                                <div class="col-md-6">
                                    <label for="alergia_ask" class="form-label">Possui alergia ou contraindica√ß√£o a
                                        medicamentos?</label>
                                    <select id="alergia_ask" name="alergia_ask" class="form-select">
                                        <option value="selecione">Selecione</option>
                                        <option value="nao">N√£o</option>
                                        <option value="sim">Sim</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="descreva_alergia_ask" class="form-label" style="display: none;">Qual
                                        alergia/contraindica√ß√£o?</label>
                                    <input type="text" id="descreva_alergia_ask" name="descreva_alergia_ask"
                                        class="form-control" placeholder="Descreva alergias" style="display: none;">
                                </div>
                            </div>
                        </div>

                        <div class="section" id="dados-responsavel" style="display: none;">
                            <h3 class="mb-4 text-primary"><i class="fas fa-user-shield me-2"></i> Dados do Respons√°vel
                            </h3>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="cpfresponsavel" class="form-label">CPF do Respons√°vel</label>
                                    <input type="text" id="cpfresponsavel" name="cpf_responsavel" class="form-control"
                                        placeholder="000.000.000-00" onblur="buscarNomeResponsavel()">
                                </div>
                                <div class="col-md-8">
                                    <label for="nomeCompletoResponsavel" class="form-label">Nome do Respons√°vel</label>
                                    <input type="text" id="nomeCompletoResponsavel" name="nome_responsavel"
                                        class="form-control" placeholder="Nome Completo">
                                </div>
                            </div>
                        </div>

                        <div class="section" id="dados-turma" onfocusin="updateProgress('dados-turma')">
                            <h3 class="mb-4 text-primary"><i class="fas fa-music me-2"></i> Dados da Turma</h3>

                            <div class="row g-3">
                                <!-- Row 1: Modalidade, N√≠vel, Turma -->
                                <div class="col-md-4">
                                    <label for="modalidade" class="form-label">Modalidade</label>
                                    <input type="text" id="modalidade" name="modalidade" class="form-control"
                                        placeholder="Modalidade" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label for="nivel" class="form-label">N√≠vel</label>
                                    <select id="nivel" name="nivel" class="form-select">
                                        <option value="">Selecione o nivel</option>
                                        <option value="nivel1">Livre</option>
                                        <option value="nivel2">Iniciante</option>
                                        <option value="nivel2">Intermedi√°rio</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="turma" class="form-label">Turma</label>
                                    <select id="turma" name="turma" class="form-select"
                                        onchange="preencherDetalhesTurma()">
                                        <option value="">Selecione a turma</option>
                                    </select>
                                </div>

                                <!-- Row 2: Dias, Hor√°rio, Sala, Professor -->
                                <div class="col-md-3">
                                    <label for="dias" class="form-label">Dias</label>
                                    <input type="text" id="dias" name="dias" class="form-control" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label for="horario" class="form-label">Hor√°rio</label>
                                    <input type="text" id="horario" name="horario" class="form-control" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label for="local" class="form-label">Sala</label>
                                    <input type="text" id="local" name="sala" class="form-control" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label for="professor" class="form-label">Professor</label>
                                    <input type="text" id="professor" name="professor" class="form-control" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="section" id="documentacao" onfocusin="updateProgress('documentacao')">
                            <h3 class="mb-4 text-primary"><i class="fas fa-file-alt me-2"></i> Documenta√ß√£o</h3>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="possuirg" class="form-label">Possui RG:</label>
                                    <select id="possuirg" name="possuirg" class="form-select">
                                        <option value=""></option>
                                        <option value="sim">Sim</option>
                                        <option value="nao">N√£o</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <!-- Placeholder to balance grid or empty -->
                                </div>

                                <!-- File Inputs Group wrapped for spacing/control -->
                                <div class="col-md-6" id="div-rg-frente" style="display: none;">
                                    <label for="rg_frente" id="label_rg_frente" class="form-label">Anexar RG/CNH
                                        frente</label>
                                    <input type="file" id="rg_frente" name="rg_frente" class="form-control">
                                </div>
                                <div class="col-md-6" id="div-rg-verso" style="display: none;">
                                    <label for="rg_verso" id="label_rg_verso" class="form-label">Anexar RG/CNH
                                        verso</label>
                                    <input type="file" id="rg_verso" name="rg_verso" class="form-control">
                                </div>

                                <div class="col-md-6" id="div-certidao" style="display: none;">
                                    <label for="certidaonascimento" id="label_certidao_nasc" class="form-label">Anexar
                                        certid√£o de nascimento</label>
                                    <input type="file" id="certidao_nasc" name="certidao_nasc" class="form-control">
                                </div>

                                <div class="col-md-6">
                                    <label for="parecer_medico" class="form-label">Anexar laudo m√©dico</label>
                                    <input type="file" id="parecer_medico" name="parecer_medico" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-primary btn-lg fw-bold shadow-sm" id="submitButton">Enviar
                                Matr√≠cula</button>
                        </div>
                    </div>

                    <div id="message" style="display: none;"
                        class="alert alert-danger mt-3 text-center fw-bold shadow-sm">
                        A Escola de Frevo do Recife destina-se a alunos com idade m√≠nima completa de 6 anos. Voc√™ j√°
                        pode fechar esta janela.
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        function updateProgress(sectionId) {
            let stepItems = document.querySelectorAll('.stepper .step-item');
            let sections = ['dados-pessoais', 'endereco', 'dados-saude', 'dados-turma', 'documentacao'];
            let sectionIndex = sections.indexOf(sectionId);

            if (sectionIndex >= 0) {
                stepItems.forEach((item, index) => {
                    item.classList.remove('active', 'completed');
                    if (index < sectionIndex) {
                        item.classList.add('completed');
                    } else if (index === sectionIndex) {
                        item.classList.add('active');
                    }
                });

                // Smooth scroll para a se√ß√£o
                const targetElement = document.getElementById(sectionId);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        // Add visual spacing to sections
        document.addEventListener("DOMContentLoaded", function () {
            let sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.classList.add('mb-5', 'pt-2');
                // Optional: add a distinct border-top or separator if desired, but padding/margin is usually enough
                // section.style.borderTop = "1px solid var(--border-color)";
                // section.style.marginTop = "2rem";
            });
        });

        function toggleFields() {
            var rgSelect = document.getElementById("possuirg");

            // Wrapper Divs
            var divRgFrente = document.getElementById("div-rg-frente");
            var divRgVerso = document.getElementById("div-rg-verso");
            var divCertidao = document.getElementById("div-certidao");

            if (rgSelect.value === "sim") {
                // Mostrar RG campos
                divRgFrente.style.display = "block";
                divRgVerso.style.display = "block";

                // Ocultar certid√£o de nascimento
                divCertidao.style.display = "none";
            } else {
                // Ocultar RG campos
                divRgFrente.style.display = "none";
                divRgVerso.style.display = "none";

                // Mostrar certid√£o de nascimento
                divCertidao.style.display = "block";
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const camposMaiusculos = [
                "nomeCompleto",
                "nomeCompletoResponsavel",
                "logradouro",
                "complemento",
                "bairro",
                "cidade",
                "qual_contraindicacao_ask",
                "descreva_atv_ask",
                "descreva_medicamento_ask",
                "descreva_alergia_ask"
            ];

            const camposMinusculos = [
                "email",
                "confirmarEmail"
            ];

            function forcarMaiusculas(event) {
                event.target.value = event.target.value.toUpperCase();
            }

            function forcarMinusculas(event) {
                event.target.value = event.target.value.toLowerCase();
            }

            // Aplica o evento de input para converter os campos para mai√∫sculas
            camposMaiusculos.forEach(id => {
                let campo = document.getElementById(id);
                if (campo) {
                    campo.addEventListener("input", forcarMaiusculas);
                } else {
                    console.warn(`‚ö†Ô∏è Campo n√£o encontrado: ${id}`);
                }
            });

            // Aplica o evento de input para converter o campo email para min√∫sculas
            camposMinusculos.forEach(id => {
                let campo = document.getElementById(id);
                if (campo) {
                    campo.addEventListener("input", forcarMinusculas);
                } else {
                    console.warn(`‚ö†Ô∏è Campo n√£o encontrado: ${id}`);
                }
            });
        });

        document.addEventListener("DOMContentLoaded", function () {
            let cpfInput = document.getElementById("cpf");
            let cpfLabel = document.querySelector("label[for='cpf']"); // Captura o r√≥tulo do CPF
            let nomeInput = document.getElementById("nomeCompleto");

            if (cpfInput.value.trim() !== "") {
                // CPF preenchido: Bloquear o campo e buscar o nome
                cpfInput.setAttribute("readonly", "true");
                // Removido oculta√ß√£o para manter vis√≠vel conforme solicitado
                // cpfInput.style.display = "none"; 
                // if (cpfLabel) cpfLabel.style.display = "none"; 
                buscarNome();
            } else {
                // CPF vazio: Exibir o campo e permitir edi√ß√£o
                cpfInput.removeAttribute("readonly");
                cpfInput.style.display = ""; // Remove qualquer oculta√ß√£o
                if (cpfLabel) cpfLabel.style.display = ""; // Remove oculta√ß√£o do r√≥tulo
            }

            // Se o Nome estiver preenchido, bloquear o campo
            if (nomeInput.value.trim() !== "") {
                nomeInput.setAttribute("readonly", "true");
            }
        });

        //busca o nome a partir do cpf
        function buscarNome() {
            let cpf = document.getElementById("cpf").value.trim();
            let nomeInput = document.getElementById("nomeCompleto");

            if (cpf.length === 11) {
                axios.post("https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/buscar-pessoa", { cpf })
                    .then(response => {
                        if (response.data.nome) {
                            nomeInput.value = response.data.nome;
                            nomeInput.setAttribute("readonly", "true"); // Bloquear o campo Nome ap√≥s preenchimento
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao buscar nome:", error);
                    });
            }
        }

        //idade e faixa et√°ria
        document.addEventListener("DOMContentLoaded", function () {
            function calcularIdade() {
                console.log("‚ñ∂Ô∏è Fun√ß√£o calcularIdade() chamada");

                let hoje = new Date();
                let nascimentoInput = document.getElementById("datanascimento");
                let idadeInput = document.getElementById("idade");
                let nascimento = new Date(nascimentoInput.value);

                if (!isNaN(nascimento) && nascimentoInput.value !== "") {
                    let idade = hoje.getFullYear() - nascimento.getFullYear();
                    let mes = hoje.getMonth() - nascimento.getMonth();
                    if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
                        idade--;
                    }
                    idadeInput.value = idade;

                    console.log("üîπ Idade calculada:", idade);

                    // Se a idade for menor que 6, interrompe a execu√ß√£o IMEDIATAMENTE
                    if (!verificarIdadeMinima(idade)) {
                        return;
                    }

                    // Se a idade for v√°lida, continua o restante do c√≥digo normalmente
                    buscarFaixaetaria();
                    verificarResponsavel(idade);
                } else {
                    idadeInput.value = "";
                }
            }

            function verificarIdadeMinima(idade) {
                console.log("‚ñ∂Ô∏è Fun√ß√£o verificarIdadeMinima() chamada com idade:", idade);

                let container = document.querySelector(".container");
                let progressBar = document.querySelector(".progress"); // Captura a barra de progresso
                let messageDiv = document.getElementById("message"); // Captura a mensagem

                let dataNascimentoInput = document.getElementById("datanascimento");
                let idadeInput = document.getElementById("idade");
                let faixaEtariaInput = document.getElementById("faixaetaria");

                if (idade < 6) {
                    console.log("‚ö†Ô∏è Idade menor que 6 detectada. Exibindo popup...");

                    let confirmacao = window.confirm(
                        "A Escola de Frevo do Recife destina-se a alunos com idade m√≠nima completa de 6 anos.\n\n" +
                        "Clique em 'OK' para fechar o formul√°rio.\n" +
                        "Clique em 'Cancelar' para limpar a data de nascimento e informar uma nova data."
                    );

                    if (confirmacao) {
                        console.log("‚úÖ Usu√°rio clicou em OK - Ocultando formul√°rio e exibindo mensagem na tela...");

                        // Oculta o formul√°rio e a barra de progresso
                        container.style.display = "none";
                        progressBar.style.display = "none";

                        // Exibe a mensagem na tela
                        messageDiv.innerHTML = "A Escola de Frevo do Recife destina-se a alunos com idade m√≠nima completa de 6 anos.";
                        messageDiv.style.display = "block";

                    } else {
                        console.log("‚ùå Usu√°rio clicou em Cancelar - Limpando campos...");
                        dataNascimentoInput.value = "";
                        idadeInput.value = "";
                        faixaEtariaInput.value = "";

                        // Mant√©m o formul√°rio e a barra de progresso vis√≠veis
                        container.style.display = "block";
                        progressBar.style.display = "flex";

                        // Esconde a mensagem da tela
                        messageDiv.style.display = "none";
                    }

                    return false; // INTERROMPE QUALQUER OUTRA EXECU√á√ÉO
                }

                console.log("‚úÖ Idade permitida, mantendo formul√°rio vis√≠vel.");
                container.style.display = "block"; // Exibe o formul√°rio normalmente se a idade for >= 6
                progressBar.style.display = "flex"; // Garante que a barra de progresso tamb√©m aparece
                messageDiv.style.display = "none"; // Esconde a mensagem se o aluno for v√°lido
                return true; // Permite que o c√≥digo continue
            }

            function buscarFaixaetaria() {
                let idadeInput = document.getElementById("idade").value.trim();

                if (idadeInput !== "") {
                    console.log("‚ñ∂Ô∏è Fun√ß√£o buscarFaixaetaria() chamada com idade:", idadeInput);

                    axios.post("https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/modalidade", { idade: idadeInput })
                        .then(response => {
                            console.log("üü¢ Resposta recebida do webhook:", response.data);

                            if (Array.isArray(response.data) && response.data.length > 0) {
                                let resultado = response.data[0];

                                if (resultado.faixa_etaria) {
                                    document.getElementById("faixaetaria").value = resultado.faixa_etaria;
                                    console.log("‚úÖ Campo Faixa Et√°ria atualizado:", resultado.faixa_etaria);
                                }

                                if (resultado.modalidade) {
                                    document.getElementById("modalidade").value = resultado.modalidade;
                                    console.log("‚úÖ Campo Modalidade atualizado:", resultado.modalidade);
                                }
                            } else {
                                console.warn("‚ö†Ô∏è Resposta inesperada do webhook:", response.data);
                            }
                        })
                        .catch(error => {
                            console.error("‚õî Erro ao consultar faixa et√°ria e modalidade:", error);
                        });
                } else {
                    console.warn("‚ö†Ô∏è Nenhuma idade informada. A consulta n√£o foi realizada.");
                }
            }

            function verificarResponsavel(idade) {
                if (typeof window.verificarNecessidadeResponsavel === "function") {
                    window.verificarNecessidadeResponsavel();
                }
            }

            // ‚¨áÔ∏è EXECUTA SOMENTE AP√ìS O USU√ÅRIO SAIR DO CAMPO (BLUR)
            document.getElementById("datanascimento").addEventListener("blur", calcularIdade);

            document.getElementById("cpfresponsavel").addEventListener("input", function () {
                this.value = this.value.replace(/\D/g, ""); // Remove caracteres n√£o num√©ricos
                if (this.value.length > 11) {
                    this.value = this.value.slice(0, 11); // Limita a 11 d√≠gitos
                }
            });

            document.getElementById("cpfresponsavel").addEventListener("blur", function () {
                if (this.value !== "" && this.value.length !== 11) { // Permite o campo vazio
                    alert("O CPF deve conter exatamente 11 d√≠gitos num√©ricos.");

                    // Aguarda o usu√°rio fechar o alerta antes de limpar o campo e restaurar o foco
                    setTimeout(() => {
                        this.value = "";
                        this.focus();
                    }, 100);
                }
            });

        });

        //Buscar nome do respons√°vel
        function buscarNomeResponsavel() {
            let cpfResponsavel = document.getElementById("cpfresponsavel").value.trim();
            let nomeResponsavelInput = document.getElementById("nomeCompletoResponsavel");

            if (cpfResponsavel.length === 11) {
                axios.post("https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/buscar-pessoa", { cpf: cpfResponsavel })
                    .then(response => {
                        if (response.data.nome) {
                            nomeResponsavelInput.value = response.data.nome;
                            nomeResponsavelInput.setAttribute("readonly", "true"); // Bloquear o campo Nome ap√≥s preenchimento
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao buscar nome do respons√°vel:", error);
                    });
            }
        }

        //Preencher endere√ßo
        function buscarEndereco() {
            let cep = document.getElementById("cep").value.trim();

            if (cep.length === 8) { // Garantir que o CEP tem 8 d√≠gitos
                // Chama a API ViaCEP
                axios.get(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(response => {
                        let data = response.data;

                        // Verifica se a API retornou um erro
                        if (!data.erro) {
                            // Preenche os campos de endere√ßo com os dados retornados
                            document.getElementById("logradouro").value = data.logradouro || "";
                            document.getElementById("bairro").value = data.bairro || "";
                            document.getElementById("cidade").value = data.localidade || "";
                            document.getElementById("complemento").value = data.complemento || "";

                            console.log("Endere√ßo preenchido com sucesso!");

                        } else {
                            alert("CEP inv√°lido. Verifique e tente novamente.");
                            console.error("Erro ao buscar o endere√ßo, CEP n√£o encontrado.");
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao buscar endere√ßo:", error);
                    });
            } else {
                alert("Por favor, insira um CEP v√°lido com 8 d√≠gitos.");
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            // üìß Valida√ß√£o e confirma√ß√£o do e-mail
            let emailInput = document.getElementById("email");
            let confirmarEmailInput = document.getElementById("confirmarEmail");

            emailInput.addEventListener("blur", function () {
                this.value = this.value.trim().toLowerCase(); // Converte para min√∫sculas

                let emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (this.value !== "" && !emailRegex.test(this.value)) {
                    alert("E-mail inv√°lido! Digite um endere√ßo v√°lido.");
                    this.value = "";
                }
            });

            confirmarEmailInput.addEventListener("blur", function () {
                if (this.value.trim() !== "" && this.value.trim().toLowerCase() !== emailInput.value.trim().toLowerCase()) {
                    alert("Os e-mails digitados n√£o coincidem. Verifique e corrija.");
                    setTimeout(() => confirmarEmailInput.focus(), 100); // Retorna o foco ap√≥s o alerta
                    this.value = ""; // Limpa o campo de confirma√ß√£o
                }
            });

            // üì± Valida√ß√£o e confirma√ß√£o do WhatsApp
            let whatsappInput = document.getElementById("whatsapp");
            let confirmarWhatsAppInput = document.getElementById("confirmarWhatsApp");

            function validarNumero(input) {
                input.value = input.value.replace(/\D/g, ""); // Remove tudo que n√£o for n√∫mero
                if (input.value.length > 11) {
                    input.value = input.value.slice(0, 11); // Limita a 11 d√≠gitos
                }
            }

            whatsappInput.addEventListener("input", function () {
                validarNumero(this);
            });

            whatsappInput.addEventListener("blur", function () {
                if (this.value.trim() !== "" && this.value.length !== 11) {
                    alert("O WhatsApp deve conter exatamente 11 d√≠gitos num√©ricos.");
                    this.value = "";
                }
            });

            confirmarWhatsAppInput.addEventListener("input", function () {
                validarNumero(this);
            });

            confirmarWhatsAppInput.addEventListener("blur", function () {
                if (this.value.trim() !== "" && this.value !== whatsappInput.value) {
                    alert("Os n√∫meros de WhatsApp digitados n√£o coincidem. Verifique e corrija.");
                    setTimeout(() => confirmarWhatsAppInput.focus(), 100); // Retorna o foco ap√≥s o alerta
                    this.value = ""; // Limpa o campo de confirma√ß√£o
                }
            });
        });

        //verificar se tipo de matr√≠cula √© inv√°lido
        function verificarTipoMatricula() {
            let tipoMatriculaInput = document.getElementById("tipoMatricula");

            if (!tipoMatriculaInput) {
                console.error("O campo 'tipoMatricula' n√£o foi encontrado no DOM.");
                return "";
            }

            let tipoMatriculaValue = tipoMatriculaInput.value.trim();

            if (!tipoMatriculaValue || tipoMatriculaValue === "{{ $json.query.tipo_matricula }}") {
                console.warn("Tipo de Matr√≠cula inv√°lido ou n√£o carregado, assumindo 'Matr√≠cula nova'.");
                tipoMatriculaInput.value = "Matr√≠cula nova"; // Define um valor padr√£o caso esteja vazio
            }

            return tipoMatriculaInput.value.trim();
        }

        //Define os niveis a partir do tipo de matr√≠cula
        document.addEventListener("DOMContentLoaded", function () {
            setTimeout(() => {
                let tipoMatriculaInput = document.getElementById("tipoMatricula");
                let nivelSelect = document.getElementById("nivel");
                let proximoNivelInput = document.getElementById("proximonivel");

                if (!tipoMatriculaInput || !nivelSelect || !proximoNivelInput) {
                    console.error("‚ùå Um dos elementos n√£o foi encontrado no DOM.");
                    return;
                }

                let tipoMatriculaValue = tipoMatriculaInput.value ? tipoMatriculaInput.value.trim() : "Matr√≠cula nova";
                let proximoNivelValue = proximoNivelInput.value.trim();

                // Se `tipoMatricula` estiver indefinido ou vazio, definir como "Matr√≠cula nova" e limpar `proximoNivel`
                if (!tipoMatriculaInput.value || tipoMatriculaInput.value.trim() === "undefined") {
                    console.warn("‚ö†Ô∏è tipoMatricula estava indefinido. Definindo como 'Matr√≠cula nova'.");
                    tipoMatriculaInput.value = "Matr√≠cula nova";
                    proximoNivelInput.value = ""; // Limpa o campo proximoNivel
                }

                console.log("üîπ Tipo de Matr√≠cula carregado:", tipoMatriculaInput.value);
                console.log("üîπ Pr√≥ximo N√≠vel carregado:", proximoNivelInput.value);

                atualizarNiveis(tipoMatriculaInput.value, proximoNivelInput.value);
            }, 300); // Pequeno delay para garantir que os valores foram carregados
        });

        // Fun√ß√£o para atualizar as op√ß√µes do select n√≠vel com base no tipo de matr√≠cula
        function atualizarNiveis(tipoMatricula, proximoNivel) {
            let nivelSelect = document.getElementById("nivel");

            if (!nivelSelect) {
                console.error("‚ùå O campo 'nivel' n√£o foi encontrado no DOM.");
                return;
            }

            nivelSelect.innerHTML = ""; // Limpa as op√ß√µes

            if (tipoMatricula === "Matr√≠cula nova") {
                console.log("üìå Configurando n√≠veis para 'Matr√≠cula nova'");
                nivelSelect.innerHTML = `
                    <option value="">Selecione o n√≠vel</option>
                    <option value="Livre">Livre</option>
                    <option value="Iniciante">Iniciante</option>
                `;
                nivelSelect.disabled = false; // Mant√©m edit√°vel
            } else if (tipoMatricula === "Renova√ß√£o" && proximoNivel) {
                console.log("üìå Configurando n√≠vel √∫nico para 'Renova√ß√£o':", proximoNivel);
                nivelSelect.innerHTML = `<option value="${proximoNivel}" selected>${proximoNivel}</option>`;
                nivelSelect.disabled = true; // Bloqueia edi√ß√£o
            }
        }

        // üîπ Buscar turmas
        function buscarTurmas() {
            let faixaEtariaInput = document.getElementById("faixaetaria");
            let nivelSelect = document.getElementById("nivel");
            let proximoNivelInput = document.getElementById("proximonivel");
            let tipoMatriculaInput = document.getElementById("tipoMatricula");

            if (!faixaEtariaInput || !nivelSelect || !proximoNivelInput || !tipoMatriculaInput) {
                console.error("‚ùå Um ou mais elementos n√£o foram encontrados no DOM.");
                return;
            }

            let faixaEtaria = faixaEtariaInput.value.trim();
            let tipoMatricula = tipoMatriculaInput.value.trim();
            let nivel = "";

            // üîπ Define o n√≠vel corretamente para o webhook
            if (tipoMatricula === "Matr√≠cula nova") {
                nivel = nivelSelect.options[nivelSelect.selectedIndex].text; // Obt√©m o TEXTO vis√≠vel do option
            } else if (tipoMatricula === "Renova√ß√£o" && proximoNivelInput.value.trim()) {
                nivel = proximoNivelInput.value.trim();
            }

            console.log("üîπ Chamando Webhook para buscar turmas...");
            console.log("Faixa Et√°ria:", faixaEtaria || "Valor n√£o encontrado!");
            console.log("N√≠vel enviado:", nivel || "Valor n√£o encontrado!");
            console.log("Tipo de Matr√≠cula:", tipoMatricula || "Valor n√£o encontrado!");

            if (!faixaEtaria || !nivel) {
                console.warn("‚ö†Ô∏è Faixa et√°ria ou n√≠vel est√° vazio. A consulta n√£o ser√° realizada.");
                return;
            }

            axios.post("https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/turmas-frevo-consulta", {
                faixa_etaria: faixaEtaria,
                nivel: nivel, // Enviando o TEXTO vis√≠vel
                tipo_de_matricula: tipoMatricula
            })
                .then(response => {
                    console.log("üü¢ Resposta do Webhook:", response.data);

                    let selectTurma = document.getElementById("turma");
                    selectTurma.innerHTML = '<option value="">Selecione a turma</option>'; // Limpa as op√ß√µes

                    if (Array.isArray(response.data) && response.data.length > 0) {
                        turmasData = response.data; // Armazena os dados das turmas
                        turmasData.forEach(item => {
                            let option = document.createElement("option");
                            option.value = item.turma;
                            option.textContent = `${item.turma} - ${item.dias} (${item.horario}) - ${item.local} - Prof. ${item.professor}`;
                            selectTurma.appendChild(option);
                        });
                    } else {
                        console.warn("‚ö†Ô∏è Nenhuma turma encontrada.");
                    }
                })
                .catch(error => {
                    console.error("‚õî Erro ao buscar turmas:", error);
                });
        }

        // üîµ Atualizar a lista de n√≠veis sempre que o `tipoMatricula` mudar
        document.getElementById("tipoMatricula").addEventListener("change", function () {
            let tipoMatricula = this.value.trim();
            let proximoNivel = document.getElementById("proximonivel").value.trim();

            // Se for "Matr√≠cula nova", limpar `proximoNivel`
            if (tipoMatricula === "Matr√≠cula nova") {
                document.getElementById("proximonivel").value = "";
            }

            atualizarNiveis(tipoMatricula, proximoNivel);
        });

        // üîπ Chamar `buscarTurmas` quando n√≠vel ou data de nascimento mudarem
        document.getElementById("datanascimento").addEventListener("blur", function () {
            buscarTurmas();
        });

        document.getElementById("nivel").addEventListener("change", function () {
            limparCamposTurma(); // Limpa os campos da turma sempre que o n√≠vel for alterado
            buscarTurmas();
        });

        // üîπ Fun√ß√£o para limpar os campos da turma ao alterar o n√≠vel
        function limparCamposTurma() {
            console.log("üßπ Limpando campos de turma...");
            document.getElementById("turma").innerHTML = '<option value="">Selecione a turma</option>';
            document.getElementById("dias").value = "";
            document.getElementById("horario").value = "";
            document.getElementById("local").value = "";
            document.getElementById("professor").value = "";
        }

        // üîπ Preencher detalhes da turma ao selecionar uma op√ß√£o
        function preencherDetalhesTurma() {
            let turmaSelecionada = document.getElementById("turma").value;
            let turmaInfo = turmasData.find(turma => turma.turma === turmaSelecionada);

            if (turmaInfo) {
                document.getElementById("dias").value = turmaInfo.dias;
                document.getElementById("horario").value = turmaInfo.horario;
                document.getElementById("local").value = turmaInfo.local;
                document.getElementById("professor").value = turmaInfo.professor;
            } else {
                limparCamposTurma();
            }
        }

        document.getElementById("turma").addEventListener("change", preencherDetalhesTurma);


        document.addEventListener("DOMContentLoaded", function () {
            let nivel = document.getElementById("nivel").value.trim();
            console.log("N√≠vel ao carregar:", nivel);

            if (nivel) {
                document.getElementById("datanascimento").addEventListener("blur", buscarTurmas);
            }
        });

        // L√≥gica unificada para exibir a se√ß√£o do Respons√°vel
        document.addEventListener("DOMContentLoaded", function () {
            window.verificarNecessidadeResponsavel = function () {
                const tipoDeficiencia = document.getElementById("tipo_def_ask");
                const cpfResponsavel = document.getElementById("cpfresponsavel");
                const nomeResponsavel = document.getElementById("nomeCompletoResponsavel");
                const sectionResponsavel = document.getElementById("dados-responsavel");
                const idadeField = document.getElementById("idade");

                if (!sectionResponsavel || !idadeField) {
                    console.warn("Elementos da se√ß√£o do respons√°vel n√£o encontrados.");
                    return;
                }

                let idade = parseInt(idadeField.value) || 0;
                let isMenor = (idade > 0 && idade < 18);
                let isIntelectual = (tipoDeficiencia && tipoDeficiencia.value.toLowerCase() === "intelectual");

                console.log(`Checking Responsible: Age=${idade}, Menor=${isMenor}, Intel=${isIntelectual}`);

                if (isMenor || isIntelectual) {
                    sectionResponsavel.style.display = "block";
                    if (cpfResponsavel) cpfResponsavel.setAttribute("required", "required");
                    if (nomeResponsavel) nomeResponsavel.setAttribute("required", "required");
                } else {
                    sectionResponsavel.style.display = "none";
                    if (cpfResponsavel) {
                        cpfResponsavel.removeAttribute("required");
                        // We don't clear values here to avoid data loss if user misclicks date, but it's an option.
                    }
                    if (nomeResponsavel) nomeResponsavel.removeAttribute("required");
                }
            };

            // Event listeners
            const pcdAsk = document.getElementById("pcd_ask");
            const tipoDeficiencia = document.getElementById("tipo_def_ask");
            if (pcdAsk) pcdAsk.addEventListener("change", window.verificarNecessidadeResponsavel);
            if (tipoDeficiencia) tipoDeficiencia.addEventListener("change", window.verificarNecessidadeResponsavel);

            // Also run on load to catch pre-filled data
            setTimeout(window.verificarNecessidadeResponsavel, 500);
        });

        // Disparar a busca ao sair (`blur`) ou mudar (`change`) o campo n√≠vel
        document.getElementById("nivel").addEventListener("blur", function () {
            if (this.value.trim()) {
                buscarTurmas();
            }
        });

        document.getElementById("nivel").addEventListener("change", function () {
            if (this.value.trim()) {
                buscarTurmas();
            }
        });

        // Atualiza os detalhes da turma quando a sele√ß√£o muda
        document.getElementById("turma").addEventListener("change", preencherDetalhesTurma);

        //Defici√™ncia
        document.addEventListener("DOMContentLoaded", function () {
            const pcdAsk = document.getElementById("pcd_ask");
            const tipoPcdLabel = document.querySelector("label[for='tipodeficiencia']");
            const tipoPcdAsk = document.getElementById("tipo_def_ask");
            const qualDefLabel = document.querySelector("label[for='qualdeficiencia']");
            const qualDeficienciaAsk = document.getElementById("qual_deficiencia_ask");

            const deficiencias = {
                "auditiva": [
                    "",
                    "Defici√™ncia auditiva",
                    "Perda auditiva de grau leve a severo",
                    "Surdez bilateral, profunda",
                    "Surdez unilateral",
                    "Outras defici√™ncias auditivas"
                ],
                "visao": [
                    "",
                    "Baixa vis√£o",
                    "Cegueira total",
                    "Vis√£o monocular",
                    "Outras defici√™ncias visuais"
                ],
                "fisica_motora": [
                    "",
                    "Amputa√ß√£o ou aus√™ncia de membro",
                    "Hemiplegia",
                    "Nanismo",
                    "Ostomia",
                    "Paralisia cerebral",
                    "Paraparesia",
                    "Paraplegia",
                    "Tetraparesia",
                    "Tetraplegia",
                    "Outras defici√™ncias f√≠sicas"
                ],
                "intelectual": [
                    "",
                    "Depress√£o grave ou persistente",
                    "Esquizofrenia",
                    "S√≠ndrome de Down",
                    "Transtorno bipolar",
                    "Transtornos de personalidade",
                    "Transtorno do espectro do autismo",
                    "Outras defici√™ncias intelectuais"
                ]
            };

            // Fun√ß√£o para exibir/ocultar campos e definir obrigatoriedade
            function toggleField(select, label, field) {
                // Tenta encontrar o container da coluna bootstrap
                const fieldContainer = field.closest('.col-md-4') || field.parentElement;

                if (select.value === "sim") {
                    fieldContainer.style.display = "block";  // Mostra a coluna
                    field.setAttribute("required", "required");
                } else {
                    fieldContainer.style.display = "none";   // Esconde a coluna
                    field.removeAttribute("required");
                    field.value = "selecione"; // Reseta o select
                }
            }

            // Inicialmente esconde
            const tipoPcdContainer = tipoPcdAsk.closest('.col-md-4');
            const qualDefContainer = qualDeficienciaAsk.closest('.col-md-4');

            tipoPcdContainer.style.display = "none";
            qualDefContainer.style.display = "none";

            tipoPcdAsk.removeAttribute("required");
            qualDeficienciaAsk.removeAttribute("required");

            // Evento para mostrar/esconder o tipo de defici√™ncia
            pcdAsk.addEventListener("change", function () {
                toggleField(pcdAsk, null, tipoPcdAsk);

                // Se "n√£o", tamb√©m esconde e reseta o campo "qual defici√™ncia"
                if (this.value !== "sim") {
                    qualDefContainer.style.display = "none";
                    qualDeficienciaAsk.removeAttribute("required");
                    qualDeficienciaAsk.innerHTML = "";
                }
            });

            tipoPcdAsk.addEventListener("change", function () {
                if (this.value !== "selecione") {
                    qualDefLabel.style.display = "block"; // O label dentro do container
                    qualDefContainer.style.display = "block"; // O container
                    qualDeficienciaAsk.style.display = "block"; // O select

                    qualDeficienciaAsk.setAttribute("required", "required");

                    let options = deficiencias[this.value];
                    qualDeficienciaAsk.innerHTML = ""; // Limpa antes de popular

                    if (options) {
                        options.forEach(option => {
                            let opt = document.createElement("option");
                            opt.value = option ? option.toLowerCase().replace(/\s+/g, "_") : "";
                            opt.textContent = option;
                            qualDeficienciaAsk.appendChild(opt);
                        });
                    }
                } else {
                    qualDefContainer.style.display = "none";
                    qualDeficienciaAsk.removeAttribute("required");
                    qualDeficienciaAsk.innerHTML = "";
                }
            });
        });

        document.addEventListener("DOMContentLoaded", function () {
            function toggleField(selectId, labelId, inputId) {
                const select = document.getElementById(selectId);
                const input = document.getElementById(inputId);
                // Encontrar o container (col-md-6)
                const container = input.closest('.col-md-6') || input.parentElement;

                // Inicialmente esconde
                container.style.display = "none";
                input.removeAttribute("required");

                select.addEventListener("change", function () {
                    if (this.value === "sim") {
                        container.style.display = "block";
                        input.setAttribute("required", "required");
                    } else {
                        container.style.display = "none";
                        input.removeAttribute("required");
                        input.value = "";
                    }
                });
            }

            toggleField("contraindicacao_medica_ask", "qual_contraindicacao_ask", "qual_contraindicacao_ask");
            toggleField("realiza_atv_ask", "descreva_atv_ask", "descreva_atv_ask");
            toggleField("usa_mediamento_ask", "descreva_medicamento_ask", "descreva_medicamento_ask");
            toggleField("alergia_ask", "descreva_alergia_ask", "descreva_alergia_ask");
        });

        function convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]); // Remove o prefixo "data:*/*;base64,"
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            const submitButton = document.getElementById("submitButton");

            if (submitButton) {
                submitButton.addEventListener("click", function (event) {
                    console.log("Bot√£o de enviar clicado");

                    let form = document.getElementById("userForm");

                    if (form) {
                        // Evita o envio padr√£o do formul√°rio
                        event.preventDefault();

                        // Construir o objeto de dados manualmente
                        let jsonData = {};

                        // Itera sobre todos os campos do formul√°rio e coleta seus valores
                        let fields = form.querySelectorAll("input, select, textarea");
                        fields.forEach(field => {
                            // Verifica se o campo tem valor e est√° habilitado
                            if (field.name && field.value !== undefined) {
                                // Se o campo for readonly ou com display: none, ainda ser√° enviado se tiver valor
                                jsonData[field.name] = field.value;
                            }
                        });

                        // Verifica se h√° campos de tipo 'file' no formul√°rio
                        let fileInputs = form.querySelectorAll("input[type='file']");
                        let filePromises = [];

                        fileInputs.forEach(fileInput => {
                            if (fileInput.files.length > 0) {
                                let file = fileInput.files[0];

                                // Adiciona a promessa de convers√£o para base64
                                filePromises.push(
                                    convertToBase64(file).then(base64File => {
                                        // Extrai a extens√£o do arquivo
                                        let fileExtension = file.name.split('.').pop();

                                        // Adiciona o arquivo convertido e a extens√£o ao JSON
                                        jsonData[`${fileInput.name}_base64`] = base64File; // Arquivo em base64
                                        jsonData[`${fileInput.name}_ext`] = fileExtension; // Extens√£o do arquivo
                                        console.log(`${fileInput.name} convertido para base64:`, base64File);
                                        console.log(`${fileInput.name} extens√£o:`, fileExtension);
                                    })
                                );
                            }
                        });

                        // Espera todas as promessas de arquivos terminarem
                        Promise.all(filePromises).then(() => {
                            // Envio via Axios
                            axios.post("https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/efr", jsonData, {
                                headers: { "Content-Type": "application/json" }
                            })
                                .then(response => {
                                    console.log("Resposta do servidor:", response.data);
                                    alert("Formul√°rio enviado com sucesso! Aguarde confirma√ß√£o.");
                                    form.reset();
                                })
                                .catch(error => {
                                    console.error("Erro ao enviar o formul√°rio:", error.response || error.message);
                                    alert(error.message);
                                });
                        }).catch(error => {
                            console.error("Erro ao converter o arquivo para base64:", error);
                            alert("Erro ao processar o arquivo. Tente novamente.");
                        });
                    } else {
                        console.error("Formul√°rio n√£o encontrado!");
                    }
                });
            }
        });

    </script>

</body>

</html>
